<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Debug Stats - Security Camera UI</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{font-family:system-ui,Arial,sans-serif}
    body{margin:0;background:#0b0c10;color:#e8e8e8}
    header{padding:14px 18px;background:#111318;position:sticky;top:0;z-index:10;display:flex;gap:10px;flex-wrap:wrap;align-items:end}
    header h1{margin:0;font-size:18px;font-weight:700}
    .nav{display:flex;gap:8px;flex-wrap:wrap}
    .nav a{background:#171a21;color:#e8e8e8;border:1px solid #2a2f3a;border-radius:8px;padding:8px 10px;text-decoration:none;transition:all 0.2s}
    .nav a:hover{background:#2a2f3a}
    .nav a.active{background:#375dfb;border-color:#375dfb;color:#fff}
    main{padding:20px;max-width:1200px;margin:0 auto}
    
    .debug-section{background:#111318;border:1px solid #2a2f3a;border-radius:14px;padding:20px;margin-bottom:20px}
    .debug-section h2{margin:0 0 15px 0;font-size:18px;font-weight:600;color:#375dfb}
    .debug-section h3{margin:15px 0 10px 0;font-size:16px;font-weight:600}
    
    .stats-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:15px;margin:20px 0}
    .stat-item{background:#1a1d29;border:1px solid #2a2f3a;border-radius:10px;padding:15px;text-align:center}
    .stat-item .value{font-size:20px;font-weight:700;color:#375dfb;margin-bottom:5px}
    .stat-item .label{font-size:12px;opacity:.8}
    
    .status-indicator{display:inline-block;width:8px;height:8px;border-radius:50%;margin-right:8px}
    .status-online{background:#44ff44}
    .status-offline{background:#ff4444}
    .status-warning{background:#ffaa00}
    
    .data-table{width:100%;border-collapse:collapse;margin:15px 0;table-layout:fixed}
    .data-table th,.data-table td{padding:10px;text-align:left;border-bottom:1px solid #2a2f3a;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
    .data-table th{background:#1a1d29;font-weight:600;color:#375dfb}
    .data-table tr:hover{background:#1a1d29}
    .data-table th:nth-child(1),.data-table td:nth-child(1){width:10%}
    .data-table th:nth-child(2),.data-table td:nth-child(2){width:20%}
    .data-table th:nth-child(3),.data-table td:nth-child(3){width:50%}
    .data-table th:nth-child(4),.data-table td:nth-child(4){width:20%}
    
    .loading{text-align:center;padding:40px;opacity:.6}
    .error{background:#ff444420;border:1px solid #ff4444;color:#ff6666;padding:15px;border-radius:8px;margin:20px 0}
    .success{background:#44ff4420;border:1px solid #44ff44;color:#66ff66;padding:15px;border-radius:8px;margin:20px 0}
    
    .refresh-btn{background:#375dfb;color:white;border:1px solid #375dfb;border-radius:8px;padding:10px 20px;cursor:pointer;margin:10px 0}
    .refresh-btn:hover{background:#4a6cf7}
    .refresh-btn:disabled{opacity:0.5;cursor:not-allowed}
    
    .json-display{background:#1a1d29;border:1px solid #2a2f3a;border-radius:8px;padding:15px;font-family:monospace;font-size:12px;white-space:pre-wrap;max-height:300px;overflow-y:auto}
    
    .endpoint-info{background:#1a1d29;border:1px solid #2a2f3a;border-radius:8px;padding:10px;margin:10px 0}
    .endpoint-info .method{display:inline-block;background:#375dfb;color:white;padding:2px 6px;border-radius:4px;font-size:10px;font-weight:bold;margin-right:8px}
    .endpoint-info .url{font-family:monospace;color:#66ff66}
    .endpoint-info .description{color:#aaa;font-size:12px;margin-top:5px}
    
    /* Mobile Navigation Styles */
    .mobile-menu-toggle {
      display: none;
      background: #171a21;
      color: #e8e8e8;
      border: 1px solid #2a2f3a;
      border-radius: 8px;
      padding: 8px 10px;
      cursor: pointer;
      font-size: 16px;
      transition: all 0.3s ease;
    }
    
    .mobile-menu-toggle:hover {
      background: #2a2f3a;
      transform: scale(1.05);
    }
    
    .mobile-menu-toggle .hamburger {
      display: flex;
      flex-direction: column;
      gap: 3px;
    }
    
    .mobile-menu-toggle .hamburger span {
      width: 18px;
      height: 2px;
      background: #e8e8e8;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      border-radius: 1px;
    }
    
    .mobile-menu-toggle.active .hamburger span:nth-child(1) {
      transform: rotate(45deg) translate(5px, 5px);
    }
    
    .mobile-menu-toggle.active .hamburger span:nth-child(2) {
      opacity: 0;
      transform: scaleX(0);
    }
    
    .mobile-menu-toggle.active .hamburger span:nth-child(3) {
      transform: rotate(-45deg) translate(7px, -6px);
    }
    
    .mobile-nav {
      display: none;
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      background: #111318;
      border: 1px solid #2a2f3a;
      border-top: none;
      border-radius: 0 0 12px 12px;
      padding: 16px;
      z-index: 1000;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
      backdrop-filter: blur(10px);
      transform: translateY(-10px);
      opacity: 0;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }
    
    .mobile-nav.show {
      display: block;
      transform: translateY(0);
      opacity: 1;
    }
    
    .mobile-nav .nav {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    
    .mobile-nav .nav a {
      background: #171a21;
      color: #e8e8e8;
      border: 1px solid #2a2f3a;
      border-radius: 10px;
      padding: 14px 18px;
      text-decoration: none;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      text-align: center;
      font-weight: 500;
      position: relative;
      overflow: hidden;
    }
    
    .mobile-nav .nav a::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(55, 93, 251, 0.1), transparent);
      transition: left 0.5s;
    }
    
    .mobile-nav .nav a:hover::before {
      left: 100%;
    }
    
    .mobile-nav .nav a:hover {
      background: #2a2f3a;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(55, 93, 251, 0.2);
    }
    
    .mobile-nav .nav a.active {
      background: linear-gradient(135deg, #375dfb, #4a6cf7);
      border-color: #375dfb;
      color: #fff;
      box-shadow: 0 4px 16px rgba(55, 93, 251, 0.3);
    }

    /* Mobile responsive */
    @media (max-width: 768px) {
      header {
        flex-wrap: wrap;
        position: relative;
        padding: 12px 16px;
      }
      
      header h1 {
        font-size: 16px;
      }
      
      .nav {
        display: none;
      }
      
      .mobile-menu-toggle {
        display: block;
        margin-left: auto;
      }
      
      main {
        padding: 16px;
        max-width: none;
      }
      
      .notifications-section {
        background: #2a1f1f;
        border: 2px solid #ff4444;
        padding: 16px;
        margin-bottom: 16px;
        border-radius: 12px;
        box-shadow: 0 0 20px rgba(255, 68, 68, 0.3);
      }
      
      .notification-item {
        background: #3a2a2a;
        border: 1px solid #ff6666;
        padding: 12px;
        margin-bottom: 8px;
        border-radius: 8px;
        display: flex;
        align-items: center;
        gap: 12px;
      }
      
      .notification-item:last-child {
        margin-bottom: 0;
      }
      
      .notification-icon {
        font-size: 20px;
        flex-shrink: 0;
      }
      
      .notification-text {
        flex: 1;
        color: #ffaaaa;
      }
      
      .debug-section {
        padding: 16px;
        margin-bottom: 16px;
        border-radius: 12px;
      }
      
      .stats-grid {
        grid-template-columns: repeat(2, 1fr);
        gap: 12px;
      }
      
      .stat-item {
        padding: 12px;
        border-radius: 8px;
      }
      
      .stat-item .value {
        font-size: 18px;
      }
      
      .refresh-btn {
        width: 100%;
        margin: 10px 0;
        padding: 12px 20px;
        font-size: 16px;
      }
      
      .endpoint-info {
        margin: 8px 0;
        padding: 8px;
      }
      
      .json-display {
        font-size: 11px;
        max-height: 200px;
      }
      
      .data-table {
        font-size: 12px;
        min-width: 600px; /* Ensure table doesn't get too compressed */
      }
      
      .data-table th,
      .data-table td {
        padding: 6px;
      }
      
      /* Mobile table improvements */
      .data-table th:nth-child(1),.data-table td:nth-child(1){width:8%}
      .data-table th:nth-child(2),.data-table td:nth-child(2){width:15%}
      .data-table th:nth-child(3),.data-table td:nth-child(3){width:55%}
      .data-table th:nth-child(4),.data-table td:nth-child(4){width:22%}
    }
    
    @media (max-width: 480px) {
      header {
        padding: 10px 12px;
      }
      
      header h1 {
        font-size: 14px;
      }
      
      main {
        padding: 12px;
      }
      
      .debug-section {
        padding: 12px;
        border-radius: 10px;
      }
      
      .stats-grid {
        grid-template-columns: 1fr;
      }
      
      .stat-item .value {
        font-size: 16px;
      }
      
      .refresh-btn {
        padding: 14px 20px;
        font-size: 18px;
      }
    }
  </style>
</head>
<body>
  <header>
    <h1>Debug Stats</h1>
    <nav class="nav">
      <a href="/ui/detections.html">AI Detections</a>
      <a href="/ui/events.html">Events</a>
      <a href="/ui/stats.html">Stats</a>
      <a href="/ui/about.html">About</a>
      <a href="/ui/debug-stats.html" class="active">Debug</a>
    </nav>
    <button class="mobile-menu-toggle" id="mobileMenuToggle">
      <div class="hamburger">
        <span></span>
        <span></span>
        <span></span>
      </div>
    </button>
    
    <!-- Mobile Navigation -->
    <div class="mobile-nav" id="mobileNav">
      <nav class="nav">
        <a href="/ui/detections.html">AI Detections</a>
        <a href="/ui/events.html">Events</a>
        <a href="/ui/stats.html">Stats</a>
        <a href="/ui/about.html">About</a>
        <a href="/ui/debug-stats.html" class="active">Debug</a>
      </nav>
    </div>
  </header>
  
  <main>
    <!-- Notifications Section -->
    <div class="notifications-section" id="notifications-section" style="display:none">
      <h2>ðŸš¨ System Alerts</h2>
      <div id="notifications-content"></div>
    </div>
    
    <div class="debug-section">
      <h2>System Overview</h2>
      <button class="refresh-btn" onclick="refreshAllData()">ðŸ”„ Refresh All Data</button>
      <div id="system-loading" class="loading">Loading system data...</div>
      <div id="system-error" class="error" style="display:none"></div>
      <div id="system-content" style="display:none">
        <div class="stats-grid" id="system-stats"></div>
      </div>
    </div>

    <div class="debug-section">
      <h2>Database Status</h2>
      <div id="db-loading" class="loading">Loading database info...</div>
      <div id="db-error" class="error" style="display:none"></div>
      <div id="db-content" style="display:none">
        <div class="stats-grid" id="db-stats"></div>
        <h3>Recent Events</h3>
        <div style="overflow-x: auto; border: 1px solid #2a2f3a; border-radius: 8px; max-height: 400px; overflow-y: auto;">
          <table class="data-table" id="recent-events-table">
            <thead>
              <tr>
                <th>ID</th>
                <th>Camera</th>
                <th>Path</th>
                <th>Timestamp</th>
              </tr>
            </thead>
            <tbody id="recent-events-body"></tbody>
          </table>
        </div>
      </div>
    </div>

    <div class="debug-section">
      <h2>File Watcher Status</h2>
      <div id="watcher-loading" class="loading">Loading watcher status...</div>
      <div id="watcher-error" class="error" style="display:none"></div>
      <div id="watcher-content" style="display:none">
        <div class="stats-grid" id="watcher-stats"></div>
      </div>
    </div>

    <div class="debug-section">
      <h2>Performance Metrics</h2>
      <div id="perf-loading" class="loading">Loading performance data...</div>
      <div id="perf-error" class="error" style="display:none"></div>
      <div id="perf-content" style="display:none">
        <div class="stats-grid" id="perf-stats"></div>
      </div>
    </div>

    <div class="debug-section">
      <h2>Program Resources</h2>
      <div id="program-resources-loading" class="loading">Loading program resource data...</div>
      <div id="program-resources-error" class="error" style="display:none"></div>
      <div id="program-resources-content" style="display:none">
        <div class="stats-grid" id="program-resources-stats"></div>
      </div>
    </div>

    <div class="debug-section">
      <h2>System Resources</h2>
      <div id="system-resources-loading" class="loading">Loading system resource data...</div>
      <div id="system-resources-error" class="error" style="display:none"></div>
      <div id="system-resources-content" style="display:none">
        <div class="stats-grid" id="system-resources-stats"></div>
      </div>
    </div>

    <div class="debug-section">
      <h2>Database Status</h2>
      <div id="database-status-loading" class="loading">Loading database status...</div>
      <div id="database-status-error" class="error" style="display:none"></div>
      <div id="database-status-content" style="display:none">
        <div class="stats-grid" id="database-status-stats"></div>
      </div>
    </div>

    <div class="debug-section">
      <h2>Database Health</h2>
      <div id="db-health-loading" class="loading">Loading database health...</div>
      <div id="db-health-error" class="error" style="display:none"></div>
      <div id="db-health-content" style="display:none">
        <div class="stats-grid" id="db-health-stats"></div>
      </div>
    </div>

    <div class="debug-section">
      <h2>Processing Queue</h2>
      <div id="processing-loading" class="loading">Loading processing status...</div>
      <div id="processing-error" class="error" style="display:none"></div>
      <div id="processing-content" style="display:none">
        <div class="stats-grid" id="processing-stats"></div>
      </div>
    </div>

    <div class="debug-section">
      <h2>Raw API Responses</h2>
      <div class="endpoint-info">
        <span class="method">GET</span>
        <span class="url">/health</span>
        <div class="description">Basic health check</div>
        <div class="json-display" id="health-raw">Loading...</div>
      </div>
      
      <div class="endpoint-info">
        <span class="method">GET</span>
        <span class="url">/stats</span>
        <div class="description">Basic system statistics</div>
        <div class="json-display" id="stats-raw">Loading...</div>
      </div>
      
      <div class="endpoint-info">
        <span class="method">GET</span>
        <span class="url">/perf</span>
        <div class="description">Performance metrics</div>
        <div class="json-display" id="perf-raw">Loading...</div>
      </div>
      
      <div class="endpoint-info">
        <span class="method">GET</span>
        <span class="url">/debug</span>
        <div class="description">Database content with samples</div>
        <div class="json-display" id="debug-raw">Loading...</div>
      </div>
      
      <div class="endpoint-info">
        <span class="method">GET</span>
        <span class="url">/scan-status</span>
        <div class="description">Live scanning status</div>
        <div class="json-display" id="scan-status-raw">Loading...</div>
      </div>
      
      <div class="endpoint-info">
        <span class="method">GET</span>
        <span class="url">/watcher-health</span>
        <div class="description">File watcher health status</div>
        <div class="json-display" id="watcher-health-raw">Loading...</div>
      </div>
      
      <div class="endpoint-info">
        <span class="method">GET</span>
        <span class="url">/system-metrics</span>
        <div class="description">System resource metrics and database size</div>
        <div class="json-display" id="system-metrics-raw">Loading...</div>
      </div>
      
      <div class="endpoint-info">
        <span class="method">GET</span>
        <span class="url">/db-health</span>
        <div class="description">Database health and performance metrics</div>
        <div class="json-display" id="db-health-raw">Loading...</div>
      </div>
      
      <div class="endpoint-info">
        <span class="method">GET</span>
        <span class="url">/processing-status</span>
        <div class="description">Processing queue status and file counts</div>
        <div class="json-display" id="processing-status-raw">Loading...</div>
      </div>
    </div>
  </main>

<script>
let refreshInterval;

async function fetchWithErrorHandling(url, displayElement) {
  try {
    const response = await fetch(url);
    const data = await response.json();
    displayElement.textContent = JSON.stringify(data, null, 2);
    return data;
  } catch (error) {
    displayElement.textContent = `Error: ${error.message}`;
    displayElement.style.color = '#ff6666';
    return null;
  }
}

// Utility function to format disk/RAM sizes
function formatSize(mb) {
  if (!mb || mb === 0) return 'N/A';
  
  if (mb >= 1024 * 1024) {
    return (mb / (1024 * 1024)).toFixed(1) + ' TB';
  } else if (mb >= 1024) {
    return (mb / 1024).toFixed(1) + ' GB';
  } else {
    return mb.toFixed(1) + ' MB';
  }
}

// Check for system health issues and display notifications
async function checkSystemHealth() {
  const notificationsSection = document.getElementById('notifications-section');
  const notificationsContent = document.getElementById('notifications-content');
  const notifications = [];
  
  try {
    // Check all system endpoints for health issues
    const [systemMetrics, dbHealth, processingStatus, watcherHealth] = await Promise.all([
      fetch('/system-metrics').then(r => r.ok ? r.json() : null).catch(() => null),
      fetch('/db-health').then(r => r.ok ? r.json() : null).catch(() => null),
      fetch('/processing-status').then(r => r.ok ? r.json() : null).catch(() => null),
      fetch('/watcher-health').then(r => r.ok ? r.json() : null).catch(() => null)
    ]);
    
    // Check system metrics for errors
    if (systemMetrics) {
      if (systemMetrics.system_memory_error) {
        notifications.push({
          icon: 'ðŸ’¾',
          text: `System Memory Error: ${systemMetrics.system_memory_error}`
        });
      }
      if (systemMetrics.system_disk_error) {
        notifications.push({
          icon: 'ðŸ’½',
          text: `System Disk Error: ${systemMetrics.system_disk_error}`
        });
      }
      if (systemMetrics.nas_disk_error) {
        notifications.push({
          icon: 'ðŸ—„ï¸',
          text: `NAS Drive Error: ${systemMetrics.nas_disk_error}`
        });
      }
      if (systemMetrics.system_cpu_error) {
        notifications.push({
          icon: 'âš¡',
          text: `CPU Monitoring Error: ${systemMetrics.system_cpu_error}`
        });
      }
    }
    
    // Check database health
    if (dbHealth && dbHealth.status !== 'Healthy' && dbHealth.status !== 'healthy') {
      notifications.push({
        icon: 'ðŸ—ƒï¸',
        text: `Database Health Issue: ${dbHealth.status}`
      });
    }
    
    // Check processing queue
    if (processingStatus && !processingStatus.queue_healthy) {
      notifications.push({
        icon: 'â³',
        text: 'Processing Queue Backlog - System may be overloaded'
      });
    }
    
    // Check watcher health
    if (watcherHealth && watcherHealth.status !== 'enabled' && watcherHealth.status !== 'Enabled') {
      notifications.push({
        icon: 'ðŸ‘ï¸',
        text: `File Watcher Issue: ${watcherHealth.status}`
      });
    }
    
    // Display notifications if any exist
    if (notifications.length > 0) {
      notificationsContent.innerHTML = notifications.map(notification => `
        <div class="notification-item">
          <div class="notification-icon">${notification.icon}</div>
          <div class="notification-text">${notification.text}</div>
        </div>
      `).join('');
      notificationsSection.style.display = 'block';
    } else {
      notificationsSection.style.display = 'none';
    }
    
  } catch (error) {
    console.error('Error checking system health:', error);
  }
}

async function refreshAllData() {
  const refreshBtn = document.querySelector('.refresh-btn');
  refreshBtn.disabled = true;
  refreshBtn.textContent = 'ðŸ”„ Refreshing...';
  
  try {
    await Promise.all([
      loadSystemData(),
      loadDatabaseData(),
      loadWatcherData(),
      loadPerformanceData(),
      loadProgramResources(),
      loadSystemResources(),
      loadDatabaseStatus(),
      loadDatabaseHealth(),
      loadProcessingStatus(),
      loadRawResponses()
    ]);
    
    // Check for health issues and display notifications
    await checkSystemHealth();
  } finally {
    refreshBtn.disabled = false;
    refreshBtn.textContent = 'ðŸ”„ Refresh All Data';
  }
}

async function loadSystemData() {
  const loading = document.getElementById('system-loading');
  const error = document.getElementById('system-error');
  const content = document.getElementById('system-content');
  const stats = document.getElementById('system-stats');
  
  try {
    const [scanStatus, basicStats, perfStats] = await Promise.all([
      fetch('/scan-status').then(r => r.ok ? r.json() : null).catch(() => null),
      fetch('/stats').then(r => r.ok ? r.json() : null).catch(() => null),
      fetch('/perf').then(r => r.ok ? r.json() : null).catch(() => null)
    ]);

    let systemData = {};
    
    if (scanStatus) {
      systemData = {
        ...systemData,
        totalEvents: scanStatus.totalEvents || 0,
        videoEvents: scanStatus.videoEvents || 0,
        thumbnailsGenerated: scanStatus.thumbnailsGenerated || 0,
        scanning: scanStatus.scanning || false
      };
    }
    
    if (basicStats) {
      systemData.events = basicStats.events || 0;
    }
    
    if (perfStats) {
      systemData.thumbnailCoverage = perfStats.thumbnailCoverage || 0;
    }

    stats.innerHTML = `
      <div class="stat-item">
        <div class="value">${systemData.totalEvents?.toLocaleString() || 'N/A'}</div>
        <div class="label">Total Events</div>
      </div>
      <div class="stat-item">
        <div class="value">${systemData.videoEvents?.toLocaleString() || 'N/A'}</div>
        <div class="label">Video Events</div>
      </div>
      <div class="stat-item">
        <div class="value">${systemData.thumbnailsGenerated?.toLocaleString() || 'N/A'}</div>
        <div class="label">Thumbnails</div>
      </div>
      <div class="stat-item">
        <div class="value">${systemData.thumbnailCoverage ? systemData.thumbnailCoverage.toFixed(1) + '%' : 'N/A'}</div>
        <div class="label">Thumbnail Coverage</div>
      </div>
      <div class="stat-item">
        <div class="value">
          <span class="status-indicator ${systemData.scanning ? 'status-warning' : 'status-online'}"></span>
          ${systemData.scanning ? 'Active' : 'Idle'}
        </div>
        <div class="label">Scanning Status</div>
      </div>
    `;

    loading.style.display = 'none';
    content.style.display = 'block';
    error.style.display = 'none';

  } catch (e) {
    console.error('Failed to load system data:', e);
    loading.style.display = 'none';
    error.style.display = 'block';
    error.textContent = 'Failed to load system data: ' + e.message;
  }
}

async function loadDatabaseData() {
  const loading = document.getElementById('db-loading');
  const error = document.getElementById('db-error');
  const content = document.getElementById('db-content');
  const stats = document.getElementById('db-stats');
  const tableBody = document.getElementById('recent-events-body');
  
  try {
    const [debugData, scanStatus] = await Promise.all([
      fetch('/debug').then(r => r.ok ? r.json() : null).catch(() => null),
      fetch('/scan-status').then(r => r.ok ? r.json() : null).catch(() => null)
    ]);

    if (debugData) {
      stats.innerHTML = `
        <div class="stat-item">
          <div class="value">${debugData.totalEvents?.toLocaleString() || 'N/A'}</div>
          <div class="label">Total Events</div>
        </div>
        <div class="stat-item">
          <div class="value">${debugData.samples?.length || 0}</div>
          <div class="label">Sample Records</div>
        </div>
      `;

      if (scanStatus && scanStatus.recentEvents) {
        tableBody.innerHTML = scanStatus.recentEvents.map(event => `
          <tr>
            <td>${event.id}</td>
            <td>${event.camera}</td>
            <td title="${event.path}">${event.path.length > 50 ? event.path.substring(0, 50) + '...' : event.path}</td>
            <td>${new Date(event.startTs * 1000).toLocaleString()}</td>
          </tr>
        `).join('');
      }
    }

    loading.style.display = 'none';
    content.style.display = 'block';
    error.style.display = 'none';

  } catch (e) {
    console.error('Failed to load database data:', e);
    loading.style.display = 'none';
    error.style.display = 'block';
    error.textContent = 'Failed to load database data: ' + e.message;
  }
}

async function loadWatcherData() {
  const loading = document.getElementById('watcher-loading');
  const error = document.getElementById('watcher-error');
  const content = document.getElementById('watcher-content');
  const stats = document.getElementById('watcher-stats');
  
  try {
    const watcherData = await fetch('/watcher-health').then(r => r.ok ? r.json() : null).catch(() => null);

    if (watcherData) {
      const isEnabled = watcherData.status === 'enabled';
      stats.innerHTML = `
        <div class="stat-item">
          <div class="value">
            <span class="status-indicator ${isEnabled ? 'status-online' : 'status-offline'}"></span>
            ${watcherData.status ? watcherData.status.charAt(0).toUpperCase() + watcherData.status.slice(1) : 'Unknown'}
          </div>
          <div class="label">Watcher Status</div>
        </div>
        <div class="stat-item">
          <div class="value">${watcherData.message || 'N/A'}</div>
          <div class="label">Status Message</div>
        </div>
      `;
    }

    loading.style.display = 'none';
    content.style.display = 'block';
    error.style.display = 'none';

  } catch (e) {
    console.error('Failed to load watcher data:', e);
    loading.style.display = 'none';
    error.style.display = 'block';
    error.textContent = 'Failed to load watcher data: ' + e.message;
  }
}

async function loadPerformanceData() {
  const loading = document.getElementById('perf-loading');
  const error = document.getElementById('perf-error');
  const content = document.getElementById('perf-content');
  const stats = document.getElementById('perf-stats');
  
  try {
    const perfData = await fetch('/perf').then(r => r.ok ? r.json() : null).catch(() => null);

    if (perfData) {
      stats.innerHTML = `
        <div class="stat-item">
          <div class="value">${perfData.totalEvents?.toLocaleString() || 'N/A'}</div>
          <div class="label">Total Events</div>
        </div>
        <div class="stat-item">
          <div class="value">${perfData.videoEvents?.toLocaleString() || 'N/A'}</div>
          <div class="label">Video Events</div>
        </div>
        <div class="stat-item">
          <div class="value">${perfData.thumbnailsGenerated?.toLocaleString() || 'N/A'}</div>
          <div class="label">Thumbnails Generated</div>
        </div>
        <div class="stat-item">
          <div class="value">${perfData.thumbnailCoverage ? perfData.thumbnailCoverage.toFixed(1) + '%' : 'N/A'}</div>
          <div class="label">Thumbnail Coverage</div>
        </div>
      `;
    }

    loading.style.display = 'none';
    content.style.display = 'block';
    error.style.display = 'none';

  } catch (e) {
    console.error('Failed to load performance data:', e);
    loading.style.display = 'none';
    error.style.display = 'block';
    error.textContent = 'Failed to load performance data: ' + e.message;
  }
}

async function loadProgramResources() {
  const loading = document.getElementById('program-resources-loading');
  const error = document.getElementById('program-resources-error');
  const content = document.getElementById('program-resources-content');
  const stats = document.getElementById('program-resources-stats');
  
  try {
    const metricsData = await fetch('/system-metrics').then(r => r.ok ? r.json() : null).catch(() => null);

    if (metricsData) {
      // Calculate program memory health status
      const memoryPercent = metricsData.program_memory_percent || 0;
      const memoryStatus = memoryPercent > 90 ? 'status-offline' : memoryPercent > 70 ? 'status-warning' : 'status-online';
      
      // Calculate goroutine health
      const goroutines = metricsData.program_goroutines || 0;
      const goroutineStatus = goroutines > 1000 ? 'status-warning' : 'status-online';
      
      stats.innerHTML = `
        <div class="stat-item">
          <div class="value">${metricsData.program_num_cpus || 'N/A'}</div>
          <div class="label">CPU Cores</div>
        </div>
        <div class="stat-item">
          <div class="value">
            <span class="status-indicator ${memoryStatus}"></span>
            ${metricsData.program_memory_used_mb ? metricsData.program_memory_used_mb.toFixed(1) + ' MB' : 'N/A'}
          </div>
          <div class="label">Memory Used</div>
        </div>
        <div class="stat-item">
          <div class="value">${metricsData.program_memory_percent ? metricsData.program_memory_percent.toFixed(1) + '%' : 'N/A'}</div>
          <div class="label">Memory %</div>
        </div>
        <div class="stat-item">
          <div class="value">${metricsData.program_memory_total_mb ? metricsData.program_memory_total_mb.toFixed(1) + ' MB' : 'N/A'}</div>
          <div class="label">Allocated Program Memory</div>
        </div>
        <div class="stat-item">
          <div class="value">
            <span class="status-indicator ${goroutineStatus}"></span>
            ${metricsData.program_goroutines || 'N/A'}
          </div>
          <div class="label">Goroutines</div>
        </div>
        <div class="stat-item">
          <div class="value">${metricsData.program_gc_cycles || 'N/A'}</div>
          <div class="label">GC Cycles</div>
        </div>
        <div class="stat-item">
          <div class="value">${metricsData.program_gc_pause_total_ms ? metricsData.program_gc_pause_total_ms.toFixed(2) + ' ms' : 'N/A'}</div>
          <div class="label">GC Pause Total</div>
        </div>
        <div class="stat-item">
          <div class="value">${metricsData.program_max_procs || 'N/A'}</div>
          <div class="label">Max Procs</div>
        </div>
      `;
    }

    loading.style.display = 'none';
    content.style.display = 'block';
    error.style.display = 'none';

  } catch (e) {
    console.error('Failed to load program resources:', e);
    loading.style.display = 'none';
    error.style.display = 'block';
    error.textContent = 'Failed to load program resources: ' + e.message;
  }
}

async function loadSystemResources() {
  const loading = document.getElementById('system-resources-loading');
  const error = document.getElementById('system-resources-error');
  const content = document.getElementById('system-resources-content');
  const stats = document.getElementById('system-resources-stats');
  
  try {
    const metricsData = await fetch('/system-metrics').then(r => r.ok ? r.json() : null).catch(() => null);

    if (metricsData) {
      // Calculate system memory health status
      const systemMemoryPercent = metricsData.system_memory_percent || 0;
      const systemMemoryStatus = metricsData.system_memory_error ? 'status-offline' : (systemMemoryPercent > 90 ? 'status-offline' : systemMemoryPercent > 80 ? 'status-warning' : 'status-online');
      
      // Calculate system disk health status
      const systemDiskPercent = metricsData.system_disk_percent || 0;
      const systemDiskStatus = metricsData.system_disk_error ? 'status-offline' : (systemDiskPercent > 90 ? 'status-offline' : systemDiskPercent > 80 ? 'status-warning' : 'status-online');
      
      // Calculate system CPU health status
      const systemCpuPercent = metricsData.system_cpu_percent || 0;
      const systemCpuStatus = systemCpuPercent > 90 ? 'status-offline' : systemCpuPercent > 80 ? 'status-warning' : 'status-online';
      
      stats.innerHTML = `
        <div class="stat-item">
          <div class="value">
            <span class="status-indicator ${systemMemoryStatus}"></span>
            ${metricsData.system_memory_error ? 'Error: ' + metricsData.system_memory_error : formatSize(metricsData.system_memory_used_mb)}
          </div>
          <div class="label">System Memory Used</div>
        </div>
        <div class="stat-item">
          <div class="value">${metricsData.system_memory_error ? 'N/A' : (metricsData.system_memory_percent ? metricsData.system_memory_percent.toFixed(1) + '%' : 'N/A')}</div>
          <div class="label">System Memory %</div>
        </div>
        <div class="stat-item">
          <div class="value">${metricsData.system_memory_error ? 'N/A' : formatSize(metricsData.system_memory_total_mb)}</div>
          <div class="label">System Memory Total</div>
        </div>
        <div class="stat-item">
          <div class="value">${metricsData.system_memory_error ? 'N/A' : formatSize(metricsData.system_memory_available_mb)}</div>
          <div class="label">System Memory Available</div>
        </div>
        <div class="stat-item">
          <div class="value">
            <span class="status-indicator ${systemDiskStatus}"></span>
            ${metricsData.system_disk_error ? 'Error: ' + metricsData.system_disk_error : formatSize(metricsData.system_disk_used_mb) + ' (' + (metricsData.system_disk_percent ? metricsData.system_disk_percent.toFixed(1) : '0') + '%)'}
          </div>
          <div class="label">System Disk Used</div>
        </div>
        <div class="stat-item">
          <div class="value">${metricsData.system_disk_error ? 'N/A' : formatSize(metricsData.system_disk_total_mb)}</div>
          <div class="label">System Disk Total</div>
        </div>
        <div class="stat-item">
          <div class="value">${metricsData.system_disk_error ? 'N/A' : formatSize(metricsData.system_disk_free_mb)}</div>
          <div class="label">System Disk Free</div>
        </div>
        <div class="stat-item">
          <div class="value">
            <span class="status-indicator ${metricsData.system_cpu_error ? 'status-offline' : systemCpuStatus}"></span>
            ${metricsData.system_cpu_error ? 'Error: ' + metricsData.system_cpu_error : (metricsData.system_cpu_percent ? metricsData.system_cpu_percent.toFixed(1) + '%' : 'N/A')}
          </div>
          <div class="label">System CPU Usage</div>
        </div>
        <div class="stat-item">
          <div class="value">
            <span class="status-indicator ${metricsData.nas_disk_error ? 'status-offline' : (metricsData.nas_disk_percent > 90 ? 'status-offline' : metricsData.nas_disk_percent > 80 ? 'status-warning' : 'status-online')}"></span>
            ${metricsData.nas_disk_error ? 'Error: ' + metricsData.nas_disk_error : formatSize(metricsData.nas_disk_used_mb) + ' (' + (metricsData.nas_disk_percent ? metricsData.nas_disk_percent.toFixed(1) : '0') + '%)'}
          </div>
          <div class="label">NAS Drive Used</div>
        </div>
        <div class="stat-item">
          <div class="value">${metricsData.nas_disk_error ? 'N/A' : (metricsData.nas_disk_percent ? metricsData.nas_disk_percent.toFixed(1) + '%' : 'N/A')}</div>
          <div class="label">NAS Drive %</div>
        </div>
        <div class="stat-item">
          <div class="value">${metricsData.nas_disk_error ? 'N/A' : formatSize(metricsData.nas_disk_total_mb)}</div>
          <div class="label">NAS Drive Total</div>
        </div>
        <div class="stat-item">
          <div class="value">${metricsData.nas_disk_error ? 'N/A' : formatSize(metricsData.nas_disk_free_mb)}</div>
          <div class="label">NAS Drive Free</div>
        </div>
      `;
    }

    loading.style.display = 'none';
    content.style.display = 'block';
    error.style.display = 'none';

  } catch (e) {
    console.error('Failed to load system resources:', e);
    loading.style.display = 'none';
    error.style.display = 'block';
    error.textContent = 'Failed to load system resources: ' + e.message;
  }
}

async function loadDatabaseStatus() {
  const loading = document.getElementById('database-status-loading');
  const error = document.getElementById('database-status-error');
  const content = document.getElementById('database-status-content');
  const stats = document.getElementById('database-status-stats');
  
  try {
    const metricsData = await fetch('/system-metrics').then(r => r.ok ? r.json() : null).catch(() => null);

    if (metricsData) {
      stats.innerHTML = `
        <div class="stat-item">
          <div class="value">${metricsData.total_events?.toLocaleString() || 'N/A'}</div>
          <div class="label">Total Events</div>
        </div>
        <div class="stat-item">
          <div class="value">${metricsData.video_events?.toLocaleString() || 'N/A'}</div>
          <div class="label">Video Events</div>
        </div>
        <div class="stat-item">
          <div class="value">${metricsData.thumbnails_generated?.toLocaleString() || 'N/A'}</div>
          <div class="label">Thumbnails Generated</div>
        </div>
        <div class="stat-item">
          <div class="value">${metricsData.thumbnail_coverage ? metricsData.thumbnail_coverage.toFixed(1) + '%' : 'N/A'}</div>
          <div class="label">Thumbnail Coverage</div>
        </div>
        <div class="stat-item">
          <div class="value">${formatSize(metricsData.database_size_mb)}</div>
          <div class="label">Database Size</div>
        </div>
        <div class="stat-item">
          <div class="value">${formatSize(metricsData.program_disk_usage_mb)}</div>
          <div class="label">Program Disk Usage</div>
        </div>
      `;
    }

    loading.style.display = 'none';
    content.style.display = 'block';
    error.style.display = 'none';

  } catch (e) {
    console.error('Failed to load database status:', e);
    loading.style.display = 'none';
    error.style.display = 'block';
    error.textContent = 'Failed to load database status: ' + e.message;
  }
}

async function loadDatabaseHealth() {
  const loading = document.getElementById('db-health-loading');
  const error = document.getElementById('db-health-error');
  const content = document.getElementById('db-health-content');
  const stats = document.getElementById('db-health-stats');
  
  try {
    const healthData = await fetch('/db-health').then(r => r.ok ? r.json() : null).catch(() => null);

    if (healthData) {
      const statusColor = (healthData.status === 'Healthy' || healthData.status === 'healthy') ? 'status-online' : 'status-offline';
      stats.innerHTML = `
        <div class="stat-item">
          <div class="value">
            <span class="status-indicator ${statusColor}"></span>
            ${healthData.status || 'Unknown'}
          </div>
          <div class="label">Database Status</div>
        </div>
        <div class="stat-item">
          <div class="value">${healthData.query_time_ms || 'N/A'} ms</div>
          <div class="label">Query Time</div>
        </div>
        <div class="stat-item">
          <div class="value">${healthData.total_records?.toLocaleString() || 'N/A'}</div>
          <div class="label">Total Records</div>
        </div>
        <div class="stat-item">
          <div class="value">${healthData.index_count || 'N/A'}</div>
          <div class="label">Indexes</div>
        </div>
      `;
    }

    loading.style.display = 'none';
    content.style.display = 'block';
    error.style.display = 'none';

  } catch (e) {
    console.error('Failed to load database health:', e);
    loading.style.display = 'none';
    error.style.display = 'block';
    error.textContent = 'Failed to load database health: ' + e.message;
  }
}

async function loadProcessingStatus() {
  const loading = document.getElementById('processing-loading');
  const error = document.getElementById('processing-error');
  const content = document.getElementById('processing-content');
  const stats = document.getElementById('processing-stats');
  
  try {
    const processingData = await fetch('/processing-status').then(r => r.ok ? r.json() : null).catch(() => null);

    if (processingData) {
      const queueHealthy = processingData.queue_healthy;
      const queueColor = queueHealthy ? 'status-online' : 'status-warning';
      stats.innerHTML = `
        <div class="stat-item">
          <div class="value">
            <span class="status-indicator ${queueColor}"></span>
            ${queueHealthy ? 'Healthy' : 'Backlog'}
          </div>
          <div class="label">Queue Status</div>
        </div>
        <div class="stat-item">
          <div class="value">${processingData.pending_files || 0}</div>
          <div class="label">Pending Files</div>
        </div>
        <div class="stat-item">
          <div class="value">${processingData.processing_files || 0}</div>
          <div class="label">Processing Files</div>
        </div>
        <div class="stat-item">
          <div class="value">${processingData.completed_files || 0}</div>
          <div class="label">Completed Files</div>
        </div>
        <div class="stat-item">
          <div class="value">${processingData.recent_processed || 0}</div>
          <div class="label">Recent (1h)</div>
        </div>
      `;
    }

    loading.style.display = 'none';
    content.style.display = 'block';
    error.style.display = 'none';

  } catch (e) {
    console.error('Failed to load processing status:', e);
    loading.style.display = 'none';
    error.style.display = 'block';
    error.textContent = 'Failed to load processing status: ' + e.message;
  }
}

async function loadRawResponses() {
  const endpoints = [
    { url: '/health', element: 'health-raw' },
    { url: '/stats', element: 'stats-raw' },
    { url: '/perf', element: 'perf-raw' },
    { url: '/debug', element: 'debug-raw' },
    { url: '/scan-status', element: 'scan-status-raw' },
    { url: '/watcher-health', element: 'watcher-health-raw' },
    { url: '/system-metrics', element: 'system-metrics-raw' },
    { url: '/db-health', element: 'db-health-raw' },
    { url: '/processing-status', element: 'processing-status-raw' }
  ];

  for (const endpoint of endpoints) {
    const element = document.getElementById(endpoint.element);
    await fetchWithErrorHandling(endpoint.url, element);
  }
}

// Auto-refresh every 30 seconds
function startAutoRefresh() {
  refreshInterval = setInterval(refreshAllData, 30000);
}

function stopAutoRefresh() {
  if (refreshInterval) {
    clearInterval(refreshInterval);
  }
}

// Mobile menu functionality
const mobileMenuToggle = document.getElementById('mobileMenuToggle');
const mobileNav = document.getElementById('mobileNav');

// Toggle mobile menu
mobileMenuToggle.addEventListener('click', function() {
  mobileMenuToggle.classList.toggle('active');
  mobileNav.classList.toggle('show');
});

// Close mobile menu when clicking outside
document.addEventListener('click', function(event) {
  if (!mobileMenuToggle.contains(event.target) && !mobileNav.contains(event.target)) {
    mobileMenuToggle.classList.remove('active');
    mobileNav.classList.remove('show');
  }
});

// Load all data on page load
document.addEventListener('DOMContentLoaded', async () => {
  await refreshAllData();
  startAutoRefresh();
});

// Stop auto-refresh when page is hidden
document.addEventListener('visibilitychange', () => {
  if (document.hidden) {
    stopAutoRefresh();
  } else {
    startAutoRefresh();
  }
});
</script>
</body>
</html>
