<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Configuration - Security Camera UI</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #0f1116;
            color: #e8e8e8;
            line-height: 1.6;
        }
        
        header {
            padding: 14px 18px;
            background: #111318;
            position: sticky;
            top: 0;
            z-index: 10;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            align-items: end;
        }
        
        header h1 {
            margin: 0;
            font-size: 18px;
            font-weight: 700;
            color: #e8e8e8;
        }
        
        .nav {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }
        
        .nav a {
            background: #171a21;
            color: #e8e8e8;
            border: 1px solid #2a2f3a;
            border-radius: 8px;
            padding: 8px 10px;
            text-decoration: none;
            transition: all 0.2s;
        }
        
        .nav a:hover {
            background: #2a2f3a;
        }
        
        .nav a.active {
            background: #375dfb;
            border-color: #375dfb;
            color: #fff;
        }
        
        main {
            padding: 24px;
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .config-section {
            background: #1a1d26;
            border: 1px solid #2a2f3a;
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 24px;
        }
        
        .config-section h2 {
            color: #e8e8e8;
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .config-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }
        
        .config-item {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .config-item label {
            color: #e8e8e8;
            font-weight: 500;
            font-size: 14px;
        }
        
        .config-item input,
        .config-item select,
        .config-item textarea {
            background: #0f1116;
            color: #e8e8e8;
            border: 1px solid #2a2f3a;
            border-radius: 8px;
            padding: 12px;
            font-size: 14px;
            transition: all 0.2s;
        }
        
        .config-item input[style*="flex: 1"] {
            border-top-right-radius: 0;
            border-bottom-right-radius: 0;
            border-right: none;
        }
        
        .config-item button[style*="white-space: nowrap"] {
            border-top-left-radius: 0;
            border-bottom-left-radius: 0;
            border-left: 1px solid #2a2f3a;
        }
        
        .config-item input:focus,
        .config-item select:focus,
        .config-item textarea:focus {
            outline: none;
            border-color: #375dfb;
            box-shadow: 0 0 0 3px rgba(55, 93, 251, 0.1);
        }
        
        .config-item textarea {
            resize: vertical;
            min-height: 80px;
        }
        
        .config-item .help-text {
            color: #8b949e;
            font-size: 12px;
            margin-top: 4px;
        }
        
        .config-item .error {
            color: #ff6b6b;
            font-size: 12px;
            margin-top: 4px;
        }
        
        .config-item .success {
            color: #51cf66;
            font-size: 12px;
            margin-top: 4px;
        }
        
        .button-group {
            display: flex;
            gap: 12px;
            margin-top: 24px;
            flex-wrap: wrap;
        }
        
        button {
            background: #375dfb;
            color: #fff;
            border: none;
            border-radius: 8px;
            padding: 12px 24px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        button:hover {
            background: #4a6cf7;
            transform: translateY(-1px);
        }
        
        button:disabled {
            background: #6c757d;
            cursor: not-allowed;
            transform: none;
        }
        
        button.secondary {
            background: #2a2f3a;
            color: #e8e8e8;
        }
        
        button.secondary:hover {
            background: #3a4049;
        }
        
        button.danger {
            background: #dc3545;
        }
        
        button.danger:hover {
            background: #c82333;
        }
        
        .status-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-right: 8px;
        }
        
        .status-online {
            background: #51cf66;
        }
        
        .status-warning {
            background: #ffd43b;
        }
        
        .status-offline {
            background: #ff6b6b;
        }
        
        .test-results {
            margin-top: 16px;
            padding: 16px;
            background: #0f1116;
            border: 1px solid #2a2f3a;
            border-radius: 8px;
            display: none;
        }
        
        .test-results.show {
            display: block;
        }
        
        .test-results.success {
            border-color: #51cf66;
            background: rgba(81, 207, 102, 0.1);
        }
        
        .test-results.error {
            border-color: #ff6b6b;
            background: rgba(255, 107, 107, 0.1);
        }
        
        .test-results h4 {
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .test-results pre {
            background: #1a1d26;
            padding: 12px;
            border-radius: 6px;
            overflow-x: auto;
            font-size: 12px;
            margin-top: 8px;
        }
        
        /* Mobile Navigation Styles */
        .mobile-menu-toggle {
            display: none;
            background: #171a21;
            color: #e8e8e8;
            border: 1px solid #2a2f3a;
            border-radius: 8px;
            padding: 8px 10px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s ease;
        }
        
        .mobile-menu-toggle:hover {
            background: #2a2f3a;
            transform: scale(1.05);
        }
        
        .mobile-menu-toggle .hamburger {
            display: flex;
            flex-direction: column;
            gap: 3px;
        }
        
        .mobile-menu-toggle .hamburger span {
            width: 18px;
            height: 2px;
            background: #e8e8e8;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            border-radius: 1px;
        }
        
        .mobile-menu-toggle.active .hamburger span:nth-child(1) {
            transform: rotate(45deg) translate(5px, 5px);
        }
        
        .mobile-menu-toggle.active .hamburger span:nth-child(2) {
            opacity: 0;
            transform: scaleX(0);
        }
        
        .mobile-menu-toggle.active .hamburger span:nth-child(3) {
            transform: rotate(-45deg) translate(7px, -6px);
        }
        
        .mobile-nav {
            display: none;
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: #111318;
            border: 1px solid #2a2f3a;
            border-top: none;
            border-radius: 0 0 12px 12px;
            padding: 16px;
            z-index: 1000;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(10px);
            transform: translateY(-10px);
            opacity: 0;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .mobile-nav.show {
            display: block;
            transform: translateY(0);
            opacity: 1;
        }
        
        .mobile-nav .nav {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .mobile-nav .nav a {
            background: #171a21;
            color: #e8e8e8;
            border: 1px solid #2a2f3a;
            border-radius: 10px;
            padding: 14px 18px;
            text-decoration: none;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            text-align: center;
            font-weight: 500;
            position: relative;
            overflow: hidden;
        }
        
        .mobile-nav .nav a::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(55, 93, 251, 0.1), transparent);
            transition: left 0.5s;
        }
        
        .mobile-nav .nav a:hover::before {
            left: 100%;
        }
        
        .mobile-nav .nav a:hover {
            background: #2a2f3a;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(55, 93, 251, 0.2);
        }
        
        .mobile-nav .nav a.active {
            background: linear-gradient(135deg, #375dfb, #4a6cf7);
            border-color: #375dfb;
            color: #fff;
            box-shadow: 0 4px 16px rgba(55, 93, 251, 0.3);
        }
        
        /* Mobile responsive styles */
        @media (max-width: 768px) {
            header {
                flex-wrap: wrap;
                position: relative;
                padding: 12px 16px;
            }
            
            header h1 {
                font-size: 16px;
            }
            
            .nav {
                display: none;
            }
            
            .mobile-menu-toggle {
                display: block;
                margin-left: auto;
            }
            
            main {
                padding: 16px;
            }
            
            .config-grid {
                grid-template-columns: 1fr;
            }
            
            .button-group {
                flex-direction: column;
            }
        }
        
        @media (max-width: 480px) {
            header {
                padding: 10px 12px;
            }
            
            header h1 {
                font-size: 14px;
            }
            
            main {
                padding: 12px;
            }
        }
        
        .loading {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid #f3f3f3;
            border-top: 2px solid #375dfb;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .alert {
            padding: 16px;
            border-radius: 8px;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .alert.info {
            background: rgba(55, 93, 251, 0.1);
            border: 1px solid #375dfb;
            color: #8bb4ff;
        }
        
        .alert.warning {
            background: rgba(255, 212, 59, 0.1);
            border: 1px solid #ffd43b;
            color: #ffd43b;
        }
        
        .alert.error {
            background: rgba(255, 107, 107, 0.1);
            border: 1px solid #ff6b6b;
            color: #ff6b6b;
        }
        
        .alert.success {
            background: rgba(81, 207, 102, 0.1);
            border: 1px solid #51cf66;
            color: #51cf66;
        }
    </style>
</head>
<body>
    <header>
        <h1>Configuration</h1>
        <nav class="nav">
            <a href="/ui/detections.html">AI Detections</a>
            <a href="/ui/events.html">Events</a>
            <a href="/ui/stats.html">Stats</a>
            <a href="/ui/about.html">About</a>
        </nav>
        <button class="mobile-menu-toggle" id="mobileMenuToggle">
            <div class="hamburger">
                <span></span>
                <span></span>
                <span></span>
            </div>
        </button>
        
        <!-- Mobile Navigation -->
        <div class="mobile-nav" id="mobileNav">
            <nav class="nav">
                <a href="/ui/detections.html">AI Detections</a>
                <a href="/ui/events.html">Events</a>
                <a href="/ui/stats.html">Stats</a>
                <a href="/ui/about.html">About</a>
                <a href="/ui/config.html" class="active">‚öôÔ∏è Configuration</a>
            </nav>
        </div>
    </header>
    
    <main>
        <!-- System Status Alert -->
        <div class="alert info" id="statusAlert" style="display: none;">
            <span>‚ÑπÔ∏è</span>
            <div>
                <strong>Configuration Status:</strong>
                <span id="statusMessage">Loading configuration...</span>
            </div>
        </div>
        
        
        <!-- Camera Directory Configuration -->
        <div class="config-section">
            <h2>üìÅ Camera Directory</h2>
            <div class="config-grid">
                <div class="config-item">
                    <label for="cameraDir">Camera Footage Directory</label>
                    <input type="text" id="cameraDir" placeholder="/path/to/camera/footage">
                    <div class="help-text">Main directory where camera footage is stored. Should contain subdirectories for each camera.</div>
                    <div class="error" id="cameraDirError"></div>
                </div>
                <div class="config-item">
                    <label for="cameraDirTest">Test Directory Access</label>
                    <button type="button" id="testCameraDir" class="secondary">Test Access</button>
                    <div class="test-results" id="cameraDirTestResults"></div>
                </div>
            </div>
        </div>
        
        <!-- Server Configuration -->
        <div class="config-section">
            <h2>üåê Server Settings</h2>
            <div class="config-grid">
                <div class="config-item">
                    <label for="serverHost">Host Address</label>
                    <input type="text" id="serverHost" placeholder="0.0.0.0">
                    <div class="help-text">IP address to bind the server to. Use 0.0.0.0 for all interfaces.</div>
                </div>
                <div class="config-item">
                    <label for="serverPort">Port</label>
                    <input type="number" id="serverPort" placeholder="8080" min="1" max="65535">
                    <div class="help-text">Port number for the web server.</div>
                </div>
                <div class="config-item">
                    <label for="corsOrigins">CORS Origins</label>
                    <input type="text" id="corsOrigins" placeholder="*">
                    <div class="help-text">Comma-separated list of allowed origins for CORS.</div>
                </div>
            </div>
        </div>
        
        <!-- Database Configuration -->
        <div class="config-section">
            <h2>üóÉÔ∏è Database Settings</h2>
            <div class="config-grid">
                <div class="config-item">
                    <label for="dbPath">Database Path</label>
                    <input type="text" id="dbPath" placeholder="./data/events.db">
                    <div class="help-text">Path to the SQLite database file.</div>
                </div>
                <div class="config-item">
                    <label for="dbBackupEnabled">Enable Auto Backup</label>
                    <select id="dbBackupEnabled">
                        <option value="true">Enabled</option>
                        <option value="false">Disabled</option>
                    </select>
                    <div class="help-text">Automatically backup database at regular intervals.</div>
                </div>
                <div class="config-item">
                    <label for="dbBackupInterval">Backup Interval</label>
                    <select id="dbBackupInterval">
                        <option value="1h">Every Hour</option>
                        <option value="6h">Every 6 Hours</option>
                        <option value="12h">Every 12 Hours</option>
                        <option value="24h">Daily</option>
                    </select>
                    <div class="help-text">How often to create database backups.</div>
                </div>
            </div>
        </div>
        
        <!-- AI Detection Configuration -->
        <div class="config-section">
            <h2>ü§ñ AI Detection Settings</h2>
            <div class="config-grid">
                <div class="config-item">
                    <label for="gpuDetectionUrl">GPU Detection Service URL</label>
                    <input type="text" id="gpuDetectionUrl" placeholder="http://localhost:8000">
                    <div class="help-text">URL of the GPU detection service for AI processing.</div>
                </div>
                <div class="config-item">
                    <label for="gpuDetectionTimeout">Detection Timeout (seconds)</label>
                    <input type="number" id="gpuDetectionTimeout" placeholder="30" min="1" max="300">
                    <div class="help-text">Timeout for AI detection requests.</div>
                </div>
                <div class="config-item">
                    <label for="detectionConfidence">Default Confidence Threshold</label>
                    <input type="number" id="detectionConfidence" placeholder="0.45" min="0" max="1" step="0.01">
                    <div class="help-text">Minimum confidence score for detections (0.0 to 1.0).</div>
                </div>
                <div class="config-item">
                    <label for="detectionClasses">Detection Classes</label>
                    <textarea id="detectionClasses" placeholder="person,car,truck,bus,bicycle,motorcycle,dog,bird"></textarea>
                    <div class="help-text">Comma-separated list of object types to detect.</div>
                </div>
            </div>
        </div>
        
        <!-- Performance Configuration -->
        <div class="config-section">
            <h2>‚ö° Performance Settings</h2>
            <div class="config-grid">
                <div class="config-item">
                    <label for="maxWorkers">Maximum Workers</label>
                    <input type="number" id="maxWorkers" placeholder="8" min="1" max="32">
                    <div class="help-text">Maximum number of concurrent file processing workers.</div>
                </div>
                <div class="config-item">
                    <label for="thumbnailQuality">Thumbnail Quality</label>
                    <input type="number" id="thumbnailQuality" placeholder="85" min="1" max="100">
                    <div class="help-text">JPEG quality for generated thumbnails (1-100).</div>
                </div>
                <div class="config-item">
                    <label for="thumbnailSize">Thumbnail Size</label>
                    <input type="number" id="thumbnailSize" placeholder="320" min="64" max="1024">
                    <div class="help-text">Maximum size for generated thumbnails in pixels.</div>
                </div>
                <div class="config-item">
                    <label for="cacheSize">Cache Size (MB)</label>
                    <input type="number" id="cacheSize" placeholder="100" min="10" max="1000">
                    <div class="help-text">Maximum cache size for thumbnails and processed data.</div>
                </div>
            </div>
        </div>
        
        <!-- Data Retention / Deletion -->
        <div class="config-section">
            <h2>üßπ Data Retention & Deletion</h2>
            <div id="dateStatsSummary" class="alert info" style="display:none;"></div>
            
            <!-- Automatic Retention Policy -->
            <div style="margin-bottom: 24px; padding: 16px; background: rgba(255,255,255,0.03); border-radius: 8px; border: 1px solid rgba(255,255,255,0.1);">
                <h3 style="margin-top:0; margin-bottom:12px;">‚è∞ Automatic Data Retention</h3>
                <div class="config-grid">
                    <div class="config-item">
                        <label for="retentionEnabled">Enable Auto Retention</label>
                        <select id="retentionEnabled">
                            <option value="false">Disabled</option>
                            <option value="true">Enabled</option>
                        </select>
                        <div class="help-text">Automatically delete data older than the retention period (runs nightly at 2 AM)</div>
                    </div>
                    <div class="config-item">
                        <label for="retentionUnit">Retention Period</label>
                        <select id="retentionUnit">
                            <option value="day">Day(s)</option>
                            <option value="week">Week(s)</option>
                            <option value="month">Month(s)</option>
                        </select>
                    </div>
                    <div class="config-item">
                        <label for="retentionAmount">Keep Last</label>
                        <input type="number" id="retentionAmount" min="1" value="30">
                        <div class="help-text">Number of periods to keep (e.g., 30 days = keep last 30 days, delete older)</div>
                    </div>
                </div>
            </div>
            
            <h3 style="margin-top: 0;">Manual Deletion</h3>
            <div class="config-grid">
                <div class="config-item">
                    <label for="deleteUnit">Delete Period</label>
                    <select id="deleteUnit">
                        <option value="day">Day(s)</option>
                        <option value="week">Week(s)</option>
                        <option value="month">Month(s)</option>
                    </select>
                </div>
                <div class="config-item">
                    <label for="deleteAmount">Amount</label>
                    <input type="number" id="deleteAmount" min="1" value="1">
                </div>
                <div class="config-item">
                    <label for="deleteEnd">Date to Delete (optional)</label>
                    <input type="date" id="deleteEnd">
                    <div class="help-text">Select a specific day to delete. If empty, uses now as the end of the deletion range.</div>
                </div>
            </div>
            <div class="button-group" id="quickDeleteButtons" style="margin-top:12px; flex-wrap:wrap;"></div>
            <div class="button-group">
                <button id="previewDelete" class="secondary">üîç Preview Deletion</button>
                <button id="executeDelete" class="danger">üóëÔ∏è Delete Data</button>
            </div>
            <div class="test-results" id="deleteResults"></div>
        </div>
        
        <!-- Backup Configuration -->
        <div class="config-section">
            <h2>üíæ Database Backup</h2>
            <div class="config-grid">
                <div class="config-item">
                    <label for="backupEnabled">Enable Auto Backup</label>
                    <select id="backupEnabled">
                        <option value="true">Enabled</option>
                        <option value="false">Disabled</option>
                    </select>
                    <div class="help-text">Automatically backup database at regular intervals.</div>
                </div>
                <div class="config-item">
                    <label for="backupTest">Test Backup System</label>
                    <button type="button" id="testBackup" class="secondary">Test Backup</button>
                    <div class="test-results" id="backupTestResults"></div>
                </div>
                <div class="config-item">
                    <label for="backupCreate">Create Manual Backup</label>
                    <button type="button" id="createBackup" class="secondary">Create Backup</button>
                    <div class="help-text">Create a backup immediately.</div>
                </div>
                <div class="config-item">
                    <label for="backupDir">Backup Directory</label>
                    <input type="text" id="backupDir" placeholder="./data/backups">
                    <div class="help-text">Directory where database backups are stored.</div>
                </div>
            </div>
        </div>

        <!-- Telegram Configuration -->
        <div class="config-section">
            <h2>üì± Telegram Notifications</h2>
            <div class="config-grid">
                <div class="config-item">
                    <label for="telegramEnabled">Enable Telegram Notifications</label>
                    <select id="telegramEnabled">
                        <option value="false">Disabled</option>
                        <option value="true">Enabled</option>
                    </select>
                    <div class="help-text">Enable Telegram notifications for detections and alerts.</div>
                </div>
                <div class="config-item">
                    <label for="telegramToken">Bot Token</label>
                    <input type="password" id="telegramToken" placeholder="123456789:ABC...">
                    <div class="help-text">Telegram bot token from @BotFather. This will be stored securely.</div>
                </div>
                <div class="config-item">
                    <label for="telegramDefaultChat">Default Chat ID</label>
                    <input type="text" id="telegramDefaultChat" placeholder="123456789">
                    <div class="help-text">Default chat ID for general notifications.</div>
                </div>
                <div class="config-item">
                    <label for="telegramSecurityChat">Security Group Chat ID</label>
                    <input type="text" id="telegramSecurityChat" placeholder="-1001234567890">
                    <div class="help-text">Chat ID for security alerts and person detections.</div>
                </div>
            </div>
        </div>

        <!-- Error Notifications Configuration -->
        <div class="config-section">
            <h2>üö® Error Notifications</h2>
            <div class="config-grid">
                <div class="config-item">
                    <label for="errorNotificationsEnabled">Enable Error Notifications</label>
                    <select id="errorNotificationsEnabled">
                        <option value="false">Disabled</option>
                        <option value="true">Enabled</option>
                    </select>
                    <div class="help-text">Enable error notifications via Python endpoint.</div>
                </div>
                <div class="config-item">
                    <label for="errorNotificationsPythonEndpoint">Python Endpoint URL</label>
                    <input type="text" id="errorNotificationsPythonEndpoint" placeholder="http://localhost:5000">
                    <div class="help-text">URL of your Python endpoint that handles error notifications.</div>
                </div>
                <div class="config-item">
                    <label for="testErrorNotifications">Test Error Notifications</label>
                    <button type="button" id="testErrorNotifications" class="secondary">Test Error Notifications</button>
                    <div class="help-text">Test the error notification system by sending a test error.</div>
                </div>
            </div>
        </div>

        <!-- Security Configuration -->
        <div class="config-section">
            <h2>üîí Security Settings</h2>
            <div class="config-grid">
                <div class="config-item">
                    <label for="rateLimitEnabled">Enable Rate Limiting</label>
                    <select id="rateLimitEnabled">
                        <option value="false">Disabled</option>
                        <option value="true">Enabled</option>
                    </select>
                    <div class="help-text">Enable rate limiting to prevent abuse.</div>
                </div>
                <div class="config-item">
                    <label for="rateLimitRequests">Rate Limit (requests per window)</label>
                    <input type="number" id="rateLimitRequests" placeholder="100" min="1" max="10000">
                    <div class="help-text">Maximum requests per time window.</div>
                </div>
                <div class="config-item">
                    <label for="rateLimitWindow">Rate Limit Window</label>
                    <select id="rateLimitWindow">
                        <option value="1m">1 Minute</option>
                        <option value="5m">5 Minutes</option>
                        <option value="15m">15 Minutes</option>
                        <option value="1h">1 Hour</option>
                    </select>
                    <div class="help-text">Time window for rate limiting.</div>
                </div>
            </div>
        </div>
        
        <!-- Action Buttons -->
        <div class="button-group">
            <button id="saveConfig" class="primary">
                <span>üíæ</span>
                Save Configuration
            </button>
            <button id="testConfig" class="secondary">
                <span>üß™</span>
                Test Configuration
            </button>
            <button id="testTelegram" class="secondary">
                <span>üì±</span>
                Test Telegram
            </button>
            <button id="resetConfig" class="secondary">
                <span>üîÑ</span>
                Reset to Defaults
            </button>
            <button id="restartService" class="danger">
                <span>üîÑ</span>
                Restart Service
            </button>
        </div>
        
        <!-- Test Results -->
        <div class="test-results" id="testResults">
            <h4>Configuration Test Results</h4>
            <pre id="testOutput"></pre>
        </div>
    </main>
    
    <script>
        // Configuration management
        let currentConfig = {};
        
        // Load configuration on page load
        document.addEventListener('DOMContentLoaded', function() {
            // Mobile menu functionality
            const mobileMenuToggle = document.getElementById('mobileMenuToggle');
            const mobileNav = document.getElementById('mobileNav');
            
            // Toggle mobile menu
            mobileMenuToggle.addEventListener('click', function() {
                mobileMenuToggle.classList.toggle('active');
                mobileNav.classList.toggle('show');
            });
            
            // Close mobile menu when clicking outside
            document.addEventListener('click', function(event) {
                if (!mobileMenuToggle.contains(event.target) && !mobileNav.contains(event.target)) {
                    mobileMenuToggle.classList.remove('active');
                    mobileNav.classList.remove('show');
                }
            });
            
            loadConfiguration();
            loadDateStats();
        });
        
        // Load configuration from server
        async function loadConfiguration() {
            try {
                const response = await fetch('/api/config');
                if (response.ok) {
                    currentConfig = await response.json();
                    populateForm(currentConfig);
                    showStatus('Configuration loaded successfully', 'success');
                } else {
                    showStatus('Failed to load configuration', 'error');
                }
            } catch (error) {
                console.error('Error loading configuration:', error);
                showStatus('Error loading configuration: ' + error.message, 'error');
            }
        }

        // Load date statistics to power quick actions
        async function loadDateStats() {
            try {
                const res = await fetch('/data/date-stats');
                if (!res.ok) return; 
                const stats = await res.json();
                const box = document.getElementById('dateStatsSummary');
                if (stats.minStartTs && stats.maxStartTs) {
                    const min = new Date(stats.minStartTs * 1000);
                    const max = new Date(stats.maxStartTs * 1000);
                    const days = Math.max(1, Math.ceil((max - min) / (1000*60*60*24)));
                    box.style.display = 'flex';
                    box.innerHTML = `<span>üìÜ</span><div><strong>Data Range:</strong> ${min.toISOString().slice(0,10)} ‚Üí ${max.toISOString().slice(0,10)} (${days} days). Total events: ${stats.totalEvents}</div>`;
                    
                    // Use the oldest date from daily array (first entry, sorted ASC) for more accurate oldest day
                    let oldestDayWithEvents = min;
                    if (stats.daily && stats.daily.length > 0 && stats.daily[0].date) {
                        // Parse YYYY-MM-DD format
                        const oldestDateStr = stats.daily[0].date;
                        const parts = oldestDateStr.split('-');
                        if (parts.length === 3) {
                            oldestDayWithEvents = new Date(parseInt(parts[0]), parseInt(parts[1]) - 1, parseInt(parts[2]));
                        }
                    }
                    renderQuickButtons(oldestDayWithEvents, max, stats.daily || []);
                }
            } catch (e) {
                // ignore
            }
        }

        function renderQuickButtons(minDate, maxDate, dailyArray) {
            const holder = document.getElementById('quickDeleteButtons');
            holder.innerHTML = '';
            const mkBtn = (label, handler, danger=false) => {
                const b = document.createElement('button');
                b.textContent = label;
                if (danger) b.classList.add('danger'); else b.classList.add('secondary');
                b.style.whiteSpace = 'nowrap';
                b.addEventListener('click', handler);
                holder.appendChild(b);
            };

            // Helpers to set unit/amount/end
            function setAndPreview(unit, amount, endDate) {
                document.getElementById('deleteUnit').value = unit;
                document.getElementById('deleteAmount').value = amount;
                if (endDate) {
                    // Format as YYYY-MM-DD for date input
                    const year = endDate.getFullYear();
                    const month = String(endDate.getMonth() + 1).padStart(2, '0');
                    const day = String(endDate.getDate()).padStart(2, '0');
                    document.getElementById('deleteEnd').value = `${year}-${month}-${day}`;
                } else {
                    document.getElementById('deleteEnd').value = '';
                }
                document.getElementById('previewDelete').click();
            }

            // Oldest slice buttons - use minDate which should be the oldest day with actual events
            mkBtn('Oldest 1 Day', () => {
                // Use the oldest day directly - the date conversion will handle sending the correct end time
                setAndPreview('day', 1, minDate);
            });
            mkBtn('Oldest 1 Week', () => {
                const end = new Date(minDate.getTime() + 7*24*60*60*1000);
                setAndPreview('week', 1, end);
            });
            mkBtn('Oldest 1 Month', () => {
                const end = new Date(minDate);
                end.setMonth(end.getMonth() + 1);
                setAndPreview('month', 1, end);
            });

            // Most recent slice buttons (end = now)
            mkBtn('Most Recent 1 Day', () => setAndPreview('day', 1, undefined));
            mkBtn('Most Recent 1 Week', () => setAndPreview('week', 1, undefined));
            mkBtn('Most Recent 1 Month', () => setAndPreview('month', 1, undefined));
        }
        
        // Populate form with configuration values
        function populateForm(config) {
            // Camera directory
            document.getElementById('cameraDir').value = config.camera_dir || '';
            document.getElementById('serverHost').value = config.server_host || '0.0.0.0';
            document.getElementById('serverPort').value = config.server_port || 8080;
            document.getElementById('corsOrigins').value = config.cors_origins || '*';
            
            // Database
            document.getElementById('dbPath').value = config.db_path || './data/events.db';
            document.getElementById('dbBackupEnabled').value = config.db_backup_enabled ? 'true' : 'false';
            document.getElementById('dbBackupInterval').value = config.db_backup_interval || '24h';
            
            // Backup
            document.getElementById('backupEnabled').value = config.backup_enabled ? 'true' : 'false';
            document.getElementById('backupDir').value = config.backup_dir || './data/backups';
            
            // AI Detection
            document.getElementById('gpuDetectionUrl').value = config.gpu_detection_url || '';
            document.getElementById('gpuDetectionTimeout').value = config.gpu_detection_timeout || 30;
            document.getElementById('detectionConfidence').value = config.detection_confidence || 0.45;
            document.getElementById('detectionClasses').value = config.detection_classes || 'person,car,truck,bus,bicycle,motorcycle,dog,bird';
            
            // Performance
            document.getElementById('maxWorkers').value = config.max_workers || 8;
            document.getElementById('thumbnailQuality').value = config.thumbnail_quality || 85;
            document.getElementById('thumbnailSize').value = config.thumbnail_size || 320;
            document.getElementById('cacheSize').value = config.cache_size || 100;
            
            // Security
            document.getElementById('rateLimitEnabled').value = config.rate_limit_enabled ? 'true' : 'false';
            document.getElementById('rateLimitRequests').value = config.rate_limit_requests || 100;
            document.getElementById('rateLimitWindow').value = config.rate_limit_window || '1m';
            
            // Telegram
            document.getElementById('telegramEnabled').value = config.telegram_enabled ? 'true' : 'false';
            document.getElementById('telegramToken').value = config.telegram_token || '';
            document.getElementById('telegramDefaultChat').value = config.telegram_default_chat || '';
            document.getElementById('telegramSecurityChat').value = config.telegram_security_chat || '';
            
            // Error Notifications
            document.getElementById('errorNotificationsEnabled').value = config.error_notifications_enabled ? 'true' : 'false';
            document.getElementById('errorNotificationsPythonEndpoint').value = config.error_notifications_python_endpoint || 'http://localhost:5000';
            
            // Data Retention
            document.getElementById('retentionEnabled').value = config.retention_enabled ? 'true' : 'false';
            document.getElementById('retentionUnit').value = config.retention_unit || 'day';
            document.getElementById('retentionAmount').value = config.retention_amount || 30;
        }
        
        // Collect form data
        function collectFormData() {
            return {
                camera_dir: document.getElementById('cameraDir').value,
                server_host: document.getElementById('serverHost').value,
                server_port: parseInt(document.getElementById('serverPort').value),
                cors_origins: document.getElementById('corsOrigins').value,
                db_path: document.getElementById('dbPath').value,
                db_backup_enabled: document.getElementById('dbBackupEnabled').value === 'true',
                db_backup_interval: document.getElementById('dbBackupInterval').value,
                backup_enabled: document.getElementById('backupEnabled').value === 'true',
                backup_dir: document.getElementById('backupDir').value,
                gpu_detection_url: document.getElementById('gpuDetectionUrl').value,
                gpu_detection_timeout: parseInt(document.getElementById('gpuDetectionTimeout').value),
                detection_confidence: parseFloat(document.getElementById('detectionConfidence').value),
                detection_classes: document.getElementById('detectionClasses').value,
                max_workers: parseInt(document.getElementById('maxWorkers').value),
                thumbnail_quality: parseInt(document.getElementById('thumbnailQuality').value),
                thumbnail_size: parseInt(document.getElementById('thumbnailSize').value),
                cache_size: parseInt(document.getElementById('cacheSize').value),
                rate_limit_enabled: document.getElementById('rateLimitEnabled').value === 'true',
                rate_limit_requests: parseInt(document.getElementById('rateLimitRequests').value),
                rate_limit_window: document.getElementById('rateLimitWindow').value,
                telegram_enabled: document.getElementById('telegramEnabled').value === 'true',
                telegram_token: document.getElementById('telegramToken').value,
                telegram_default_chat: document.getElementById('telegramDefaultChat').value,
                telegram_security_chat: document.getElementById('telegramSecurityChat').value,
                error_notifications_enabled: document.getElementById('errorNotificationsEnabled').value === 'true',
                error_notifications_python_endpoint: document.getElementById('errorNotificationsPythonEndpoint').value,
                retention_enabled: document.getElementById('retentionEnabled').value === 'true',
                retention_unit: document.getElementById('retentionUnit').value,
                retention_amount: parseInt(document.getElementById('retentionAmount').value || '30')
            };
        }
        
        // Show status message
        function showStatus(message, type) {
            const alert = document.getElementById('statusAlert');
            const messageEl = document.getElementById('statusMessage');
            
            messageEl.textContent = message;
            alert.className = `alert ${type}`;
            alert.style.display = 'flex';
            
            // Auto-hide after 5 seconds
            setTimeout(() => {
                alert.style.display = 'none';
            }, 5000);
        }

        
        // Save configuration
        document.getElementById('saveConfig').addEventListener('click', async function() {
            const config = collectFormData();
            
            try {
                const response = await fetch('/api/config', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(config)
                });
                
                if (response.ok) {
                    showStatus('Configuration saved successfully', 'success');
                    currentConfig = config;
                } else {
                    // Try to parse JSON error response
                    let errorMessage = 'Unknown error';
                    const contentType = response.headers.get('content-type');
                    if (contentType && contentType.includes('application/json')) {
                        try {
                            const errorData = await response.json();
                            errorMessage = errorData.error || errorData.message || 'Unknown error';
                            if (errorData.details) {
                                errorMessage += ': ' + errorData.details;
                            }
                        } catch (e) {
                            errorMessage = 'Failed to parse error response';
                        }
                    } else {
                        // Fallback to text if not JSON
                        errorMessage = await response.text();
                    }
                    console.error('Failed to save configuration:', errorMessage);
                    showStatus('Failed to save configuration: ' + errorMessage, 'error');
                }
            } catch (error) {
                console.error('Error saving configuration:', error);
                showStatus('Error saving configuration: ' + error.message, 'error');
            }
        });
        
        // Test configuration
        document.getElementById('testConfig').addEventListener('click', async function() {
            const config = collectFormData();
            const testResults = document.getElementById('testResults');
            const testOutput = document.getElementById('testOutput');
            
            testResults.className = 'test-results show';
            testOutput.textContent = 'Testing configuration...';
            
            try {
                const response = await fetch('/api/config/test', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(config)
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    testResults.classList.add('success');
                    testOutput.textContent = JSON.stringify(result, null, 2);
                } else {
                    testResults.classList.add('error');
                    testOutput.textContent = JSON.stringify(result, null, 2);
                }
            } catch (error) {
                testResults.classList.add('error');
                testOutput.textContent = 'Error testing configuration: ' + error.message;
            }
        });
        
        // Test Telegram
        document.getElementById('testTelegram').addEventListener('click', async function() {
            const config = collectFormData();
            const testResults = document.getElementById('testResults');
            const testOutput = document.getElementById('testOutput');
            
            testResults.className = 'test-results show';
            testOutput.textContent = 'Testing Telegram configuration...';
            
            try {
                const response = await fetch('/telegram/test', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(config)
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    testOutput.textContent = `‚úÖ Telegram test successful!\n\n${JSON.stringify(result, null, 2)}`;
                    showStatus('Telegram test completed successfully', 'success');
                } else {
                    testOutput.textContent = `‚ùå Telegram test failed:\n\n${JSON.stringify(result, null, 2)}`;
                    showStatus('Telegram test failed: ' + (result.error || 'Unknown error'), 'error');
                }
            } catch (error) {
                console.error('Error testing Telegram:', error);
                testOutput.textContent = `‚ùå Error testing Telegram: ${error.message}`;
                showStatus('Error testing Telegram: ' + error.message, 'error');
            }
        });

        // Preview deletion
        document.getElementById('previewDelete').addEventListener('click', async function() {
            const unit = document.getElementById('deleteUnit').value;
            const amount = parseInt(document.getElementById('deleteAmount').value || '1');
            const endDateStr = document.getElementById('deleteEnd').value;
            let endISO = undefined;
            if (endDateStr) {
                // Convert date picker value (YYYY-MM-DD) to ISO8601
                // Parse the date string directly to avoid timezone issues
                const parts = endDateStr.split('-');
                if (parts.length === 3) {
                    // Send the selected date at midnight UTC as a marker
                    // Backend will interpret this and calculate the proper range in local timezone
                    const year = parseInt(parts[0]);
                    const month = parseInt(parts[1]);
                    const day = parseInt(parts[2]);
                    // Create date at start of selected day in UTC (marker date)
                    const selectedDate = new Date(Date.UTC(year, month - 1, day, 0, 0, 0, 0));
                    endISO = selectedDate.toISOString();
                }
            }
            const out = document.getElementById('deleteResults');
            out.className = 'test-results show';
            out.innerHTML = '<h4>üîç Previewing...</h4><pre>Calculating day folders to delete...</pre>';
            try {
                const resp = await fetch('/delete/range', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ unit, amount, end: endISO, preview: true })
                });
                const res = await resp.json();
                if (resp.ok) {
                    out.className = 'test-results show success';
                    let msg = `Will delete ${res.dayFolders || 0} day folder(s) containing ${res.baseEvents || 0} events`;
                    if (res.totalSize) {
                        msg += ` (${res.totalSize})`;
                    }
                    if (res.detectionEvents > 0) {
                        msg += ` and ${res.detectionEvents} detection events`;
                    }
                    msg += `\n\nSample folders:\n`;
                    if (res.sampleFolders && res.sampleFolders.length > 0) {
                        res.sampleFolders.forEach(f => msg += `  ‚Ä¢ ${f}\n`);
                    } else {
                        msg += `  (none found)\n`;
                    }
                    out.innerHTML = `<h4>‚úÖ Preview</h4><pre>${msg}</pre>`;
                } else {
                    out.className = 'test-results show error';
                    out.innerHTML = `<h4>‚ùå Error</h4><pre>${JSON.stringify(res, null, 2)}</pre>`;
                }
            } catch (e) {
                out.className = 'test-results show error';
                out.innerHTML = `<h4>‚ùå Error</h4><pre>${e.message}</pre>`;
            }
        });

        // Execute deletion
        document.getElementById('executeDelete').addEventListener('click', async function() {
            if (!confirm('This will permanently delete entire day folders and database records in the selected period. Continue?')) return;
            const unit = document.getElementById('deleteUnit').value;
            const amount = parseInt(document.getElementById('deleteAmount').value || '1');
            const endDateStr = document.getElementById('deleteEnd').value;
            let endISO = undefined;
            if (endDateStr) {
                // Convert date picker value (YYYY-MM-DD) to ISO8601
                // Parse the date string directly to avoid timezone issues
                const parts = endDateStr.split('-');
                if (parts.length === 3) {
                    // Send the selected date at midnight UTC as a marker
                    // Backend will interpret this and calculate the proper range in local timezone
                    const year = parseInt(parts[0]);
                    const month = parseInt(parts[1]);
                    const day = parseInt(parts[2]);
                    // Create date at start of selected day in UTC (marker date)
                    const selectedDate = new Date(Date.UTC(year, month - 1, day, 0, 0, 0, 0));
                    endISO = selectedDate.toISOString();
                }
            }
            const out = document.getElementById('deleteResults');
            out.className = 'test-results show';
            out.innerHTML = '<h4>üóëÔ∏è Deleting...</h4><pre>Deleting day folders and records...</pre>';
            try {
                const resp = await fetch('/delete/range', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ unit, amount, end: endISO, preview: false })
                });
                const res = await resp.json();
                if (resp.ok) {
                    out.className = 'test-results show success';
                    let msg = `Successfully deleted:\n`;
                    msg += `  ‚Ä¢ ${res.deletedFolders || 0} day folder(s)\n`;
                    if (res.deletedMonthFolders > 0) {
                        msg += `  ‚Ä¢ ${res.deletedMonthFolders} empty month folder(s)\n`;
                    }
                    msg += `  ‚Ä¢ ${res.deletedBaseEvents || 0} base events\n`;
                    if (res.deletedDetections > 0) {
                        msg += `  ‚Ä¢ ${res.deletedDetections} detection events\n`;
                    }
                    if (res.cleanedDetections > 0) {
                        msg += `  ‚Ä¢ ${res.cleanedDetections} detection artifacts cleaned\n`;
                    }
                    if (res.failedSamples && res.failedSamples.length > 0) {
                        msg += `\n‚ö†Ô∏è ${res.failedSamples.length} folder(s) failed to delete:\n`;
                        res.failedSamples.forEach(f => msg += `  ‚Ä¢ ${f.path}: ${f.error}\n`);
                    }
                    out.innerHTML = `<h4>‚úÖ Deleted</h4><pre>${msg}</pre>`;
                } else {
                    out.className = 'test-results show error';
                    out.innerHTML = `<h4>‚ùå Error</h4><pre>${JSON.stringify(res, null, 2)}</pre>`;
                }
            } catch (e) {
                out.className = 'test-results show error';
                out.innerHTML = `<h4>‚ùå Error</h4><pre>${e.message}</pre>`;
            }
        });
        
        // Test Error Notifications
        document.getElementById('testErrorNotifications').addEventListener('click', async function() {
            const config = collectFormData();
            const testResults = document.getElementById('testResults');
            const testOutput = document.getElementById('testOutput');
            
            testResults.className = 'test-results show';
            testOutput.textContent = 'Testing Error Notifications configuration...';
            
            try {
                const response = await fetch('/error-notifications/test', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(config)
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    testOutput.textContent = `‚úÖ Error Notifications test successful!\n\n${JSON.stringify(result, null, 2)}`;
                    showStatus('Error Notifications test completed successfully', 'success');
                } else {
                    testOutput.textContent = `‚ùå Error Notifications test failed:\n\n${JSON.stringify(result, null, 2)}`;
                    showStatus('Error Notifications test failed: ' + (result.error || 'Unknown error'), 'error');
                }
            } catch (error) {
                console.error('Error testing Error Notifications:', error);
                testOutput.textContent = `‚ùå Error testing Error Notifications: ${error.message}`;
                showStatus('Error testing Error Notifications: ' + error.message, 'error');
            }
        });
        
        // Reset configuration
        document.getElementById('resetConfig').addEventListener('click', function() {
            if (confirm('Are you sure you want to reset all configuration to defaults? This cannot be undone.')) {
                populateForm({});
                showStatus('Configuration reset to defaults', 'info');
            }
        });
        
        // Restart service
        document.getElementById('restartService').addEventListener('click', async function() {
            if (confirm('Are you sure you want to restart the service? This will temporarily interrupt service.')) {
                try {
                    const response = await fetch('/api/config/restart', {
                        method: 'POST'
                    });
                    
                    if (response.ok) {
                        showStatus('Service restart initiated', 'info');
                    } else {
                        showStatus('Failed to restart service', 'error');
                    }
                } catch (error) {
                    showStatus('Error restarting service: ' + error.message, 'error');
                }
            }
        });
        
        // Test backup system
        document.getElementById('testBackup').addEventListener('click', async function() {
            const testResults = document.getElementById('backupTestResults');
            
            testResults.className = 'test-results show';
            testResults.innerHTML = '<h4>üîÑ Testing...</h4><pre>Testing backup system...</pre>';
            
            try {
                const response = await fetch('/api/backup/test', {
                    method: 'POST'
                });
                
                const result = await response.json();
                
                if (response.ok && result.valid) {
                    testResults.className = 'test-results show success';
                    testResults.innerHTML = `<h4>‚úÖ Success</h4><pre>${result.message}</pre>`;
                } else {
                    testResults.className = 'test-results show error';
                    testResults.innerHTML = `<h4>‚ùå Error</h4><pre>${result.error || result.message}</pre>`;
                }
            } catch (error) {
                testResults.className = 'test-results show error';
                testResults.innerHTML = `<h4>‚ùå Error</h4><pre>Error testing backup system: ${error.message}</pre>`;
            }
        });

        // Create manual backup
        document.getElementById('createBackup').addEventListener('click', async function() {
            const button = document.getElementById('createBackup');
            const originalText = button.innerHTML;
            
            button.innerHTML = '<span class="loading"></span> Creating Backup...';
            button.disabled = true;
            
            try {
                const response = await fetch('/api/backup/create', {
                    method: 'POST'
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    showStatus('Backup created successfully', 'success');
                } else {
                    showStatus('Failed to create backup: ' + result.error, 'error');
                }
            } catch (error) {
                showStatus('Error creating backup: ' + error.message, 'error');
            } finally {
                button.innerHTML = originalText;
                button.disabled = false;
            }
        });


        // Test camera directory
        document.getElementById('testCameraDir').addEventListener('click', async function() {
            const cameraDir = document.getElementById('cameraDir').value;
            const testResults = document.getElementById('cameraDirTestResults');
            
            if (!cameraDir) {
                testResults.className = 'test-results show error';
                testResults.innerHTML = '<h4>‚ùå Error</h4><pre>Please enter a camera directory path</pre>';
                return;
            }
            
            testResults.className = 'test-results show';
            testResults.innerHTML = '<h4>üîÑ Testing...</h4><pre>Testing camera directory access...</pre>';
            
            try {
                const response = await fetch('/api/config/test-directory', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ path: cameraDir })
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    testResults.className = 'test-results show success';
                    testResults.innerHTML = `<h4>‚úÖ Success</h4><pre>${JSON.stringify(result, null, 2)}</pre>`;
                } else {
                    testResults.className = 'test-results show error';
                    testResults.innerHTML = `<h4>‚ùå Error</h4><pre>${JSON.stringify(result, null, 2)}</pre>`;
                }
            } catch (error) {
                testResults.className = 'test-results show error';
                testResults.innerHTML = `<h4>‚ùå Error</h4><pre>Error testing directory: ${error.message}</pre>`;
            }
        });
    </script>
</body>
</html>
