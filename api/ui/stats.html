<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Motion Detection Stats</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root{font-family:system-ui,Arial,sans-serif}
    body{margin:0;background:#0b0c10;color:#e8e8e8}
    header{padding:14px 18px;background:#111318;position:sticky;top:0;z-index:10;display:flex;gap:10px;flex-wrap:wrap;align-items:end}
    header h1{margin:0;font-size:18px;font-weight:700}
    .nav{display:flex;gap:8px;flex-wrap:wrap}
    .nav a{background:#171a21;color:#e8e8e8;border:1px solid #2a2f3a;border-radius:8px;padding:8px 10px;text-decoration:none;transition:all 0.2s}
    .nav a:hover{background:#2a2f3a}
    .nav a.active{background:#375dfb;border-color:#375dfb;color:#fff}
    .controls{display:flex;gap:8px;flex-wrap:wrap;margin-left:auto}
    input,button,select{background:#171a21;color:#e8e8e8;border:1px solid #2a2f3a;border-radius:8px;padding:8px 10px}
    button.primary{background:#375dfb;border-color:#375dfb;color:#fff}
    main{padding:16px}
    .stats-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(400px,1fr));gap:20px;margin-bottom:20px}
    .stat-card{background:#111318;border:1px solid #2a2f3a;border-radius:14px;padding:20px}
    .stat-card h3{margin:0 0 15px 0;font-size:16px;font-weight:600}
    .chart-container{position:relative;height:300px;margin-top:10px}
    .summary-stats{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:15px;margin-bottom:20px}
    .summary-item{background:#111318;border:1px solid #2a2f3a;border-radius:10px;padding:15px;text-align:center}
    .summary-item .value{font-size:24px;font-weight:700;color:#375dfb;margin-bottom:5px}
    .summary-item .label{font-size:12px;opacity:.8}
    .loading{text-align:center;padding:40px;opacity:.6}
    .error{background:#ff444420;border:1px solid #ff4444;color:#ff6666;padding:15px;border-radius:8px;margin:20px 0}
    .status{background:#1a1d29;border:1px solid #2a2f3a;border-radius:8px;padding:8px 12px;font-size:12px;opacity:.8;margin-left:10px}
    .status.loading{opacity:1;background:#375dfb20;border-color:#375dfb}
    .status.error{background:#ff444420;border-color:#ff4444;color:#ff6666}
    
    /* Detection-specific styles */
    .detection-stats{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:16px;margin-bottom:24px}
    .detection-card{background:#111318;border:1px solid #2a2f3a;border-radius:12px;padding:16px;text-align:center}
    .detection-value{font-size:24px;font-weight:700;color:#375dfb;margin-bottom:4px}
    .detection-label{font-size:12px;opacity:.7}
    
    .detection-list{background:#111318;border:1px solid #2a2f3a;border-radius:12px;overflow:hidden;margin-top:24px}
    .detection-item{display:flex;align-items:center;padding:12px 16px;border-bottom:1px solid #2a2f3a;transition:background 0.2s}
    .detection-item:hover{background:#171a21}
    .detection-item:last-child{border-bottom:none}
    .detection-type{font-weight:600;min-width:80px;flex-shrink:0}
    .detection-confidence{min-width:60px;text-align:right;font-family:monospace;flex-shrink:0}
    .detection-time{min-width:120px;font-size:12px;opacity:.7;flex-shrink:0}
    .detection-bbox{font-size:12px;opacity:.6;font-family:monospace;flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
    
    .confidence-bar{width:100px;height:4px;background:#2a2f3a;border-radius:2px;margin:0 8px;overflow:hidden}
    .confidence-fill{height:100%;background:linear-gradient(90deg,#ff4444 0%,#ffaa44 50%,#44ff44 100%);transition:width 0.3s}
    
    .filter-section{background:#111318;border:1px solid #2a2f3a;border-radius:12px;padding:16px;margin-bottom:24px}
    .filter-row{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
    .filter-row label{font-size:12px;opacity:.8;min-width:80px}
    
    .detection-badge{display:inline-block;padding:2px 6px;border-radius:4px;font-size:10px;font-weight:600;margin-right:4px}
    .detection-badge.person{background:#375dfb20;color:#375dfb;border:1px solid #375dfb}
    .detection-badge.car{background:#44ff4420;color:#44ff44;border:1px solid #44ff44}
    .detection-badge.truck{background:#ffaa4420;color:#ffaa44;border:1px solid #ffaa44}
    .detection-badge.bicycle{background:#ff44ff20;color:#ff44ff;border:1px solid #ff44ff}
    .detection-badge.other{background:#66666620;color:#666666;border:1px solid #666666}
    
    /* Mobile Navigation Styles */
    .mobile-menu-toggle {
      display: none;
      background: #171a21;
      color: #e8e8e8;
      border: 1px solid #2a2f3a;
      border-radius: 8px;
      padding: 8px 10px;
      cursor: pointer;
      font-size: 16px;
      transition: all 0.3s ease;
    }
    
    .mobile-menu-toggle:hover {
      background: #2a2f3a;
      transform: scale(1.05);
    }
    
    .mobile-menu-toggle .hamburger {
      display: flex;
      flex-direction: column;
      gap: 3px;
    }
    
    .mobile-menu-toggle .hamburger span {
      width: 18px;
      height: 2px;
      background: #e8e8e8;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      border-radius: 1px;
    }
    
    .mobile-menu-toggle.active .hamburger span:nth-child(1) {
      transform: rotate(45deg) translate(5px, 5px);
    }
    
    .mobile-menu-toggle.active .hamburger span:nth-child(2) {
      opacity: 0;
      transform: scaleX(0);
    }
    
    .mobile-menu-toggle.active .hamburger span:nth-child(3) {
      transform: rotate(-45deg) translate(7px, -6px);
    }
    
    .mobile-nav {
      display: none;
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      background: #111318;
      border: 1px solid #2a2f3a;
      border-top: none;
      border-radius: 0 0 12px 12px;
      padding: 16px;
      z-index: 1000;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
      backdrop-filter: blur(10px);
      transform: translateY(-10px);
      opacity: 0;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }
    
    .mobile-nav.show {
      display: block;
      transform: translateY(0);
      opacity: 1;
    }
    
    .mobile-nav .nav {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    
    .mobile-nav .nav a {
      background: #171a21;
      color: #e8e8e8;
      border: 1px solid #2a2f3a;
      border-radius: 10px;
      padding: 14px 18px;
      text-decoration: none;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      text-align: center;
      font-weight: 500;
      position: relative;
      overflow: hidden;
    }
    
    .mobile-nav .nav a::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(55, 93, 251, 0.1), transparent);
      transition: left 0.5s;
    }
    
    .mobile-nav .nav a:hover::before {
      left: 100%;
    }
    
    .mobile-nav .nav a:hover {
      background: #2a2f3a;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(55, 93, 251, 0.2);
    }
    
    .mobile-nav .nav a.active {
      background: linear-gradient(135deg, #375dfb, #4a6cf7);
      border-color: #375dfb;
      color: #fff;
      box-shadow: 0 4px 16px rgba(55, 93, 251, 0.3);
    }
    
    .mobile-controls {
      display: none;
      margin-top: 16px;
      padding-top: 16px;
      border-top: 1px solid #2a2f3a;
    }
    
    .mobile-controls .controls {
      display: flex;
      flex-direction: column;
      gap: 12px;
      margin-left: 0;
    }
    
    .mobile-controls input,
    .mobile-controls button,
    .mobile-controls select {
      width: 100%;
      box-sizing: border-box;
      padding: 12px 16px;
      border-radius: 8px;
      font-size: 14px;
      transition: all 0.3s ease;
    }
    
    .mobile-controls input:focus,
    .mobile-controls select:focus {
      outline: none;
      border-color: #375dfb;
      box-shadow: 0 0 0 3px rgba(55, 93, 251, 0.1);
    }
    
    .mobile-controls button {
      font-weight: 500;
      transition: all 0.3s ease;
    }
    
    .mobile-controls button:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
    }
    
    .mobile-controls button.primary {
      background: linear-gradient(135deg, #375dfb, #4a6cf7);
      border: none;
      box-shadow: 0 2px 8px rgba(55, 93, 251, 0.3);
    }
    
    .mobile-controls button.primary:hover {
      box-shadow: 0 4px 16px rgba(55, 93, 251, 0.4);
    }
    
    /* Mobile responsive styles */
    @media (max-width: 768px) {
      header {
        flex-wrap: wrap;
        position: relative;
        padding: 12px 16px;
      }
      
      header h1 {
        font-size: 16px;
      }
      
      .nav {
        display: none;
      }
      
      .controls {
        display: none;
      }
      
      .mobile-menu-toggle {
        display: block;
        margin-left: auto;
      }
      
      .mobile-nav .mobile-controls {
        display: block;
      }
      
      main {
        padding: 16px;
      }
      
      .stats-grid {
        grid-template-columns: 1fr;
        gap: 16px;
      }
      
      .summary-stats {
        grid-template-columns: repeat(2, 1fr);
        gap: 12px;
      }
      
      .detection-stats {
        grid-template-columns: repeat(2, 1fr);
        gap: 12px;
      }
      
      .stat-card {
        padding: 16px;
        border-radius: 12px;
      }
      
      .summary-item {
        padding: 12px;
        border-radius: 8px;
      }
      
      .detection-card {
        padding: 12px;
        border-radius: 8px;
      }
      
      .filter-section {
        padding: 12px;
        border-radius: 10px;
      }
      
      .detection-list {
        border-radius: 10px;
      }
    }
    
    @media (max-width: 480px) {
      header {
        padding: 10px 12px;
      }
      
      header h1 {
        font-size: 14px;
      }
      
      main {
        padding: 12px;
      }
      
      .summary-stats {
        grid-template-columns: 1fr;
      }
      
      .detection-stats {
        grid-template-columns: 1fr;
      }
      
      .summary-item .value {
        font-size: 20px;
      }
      
      .detection-value {
        font-size: 20px;
      }
      
      .stat-card h3 {
        font-size: 14px;
      }
    }
  </style>
</head>
<body>
  <header>
    <h1>Security Camera Analytics</h1>
    <nav class="nav">
      <a href="/ui/detections.html">AI Detections</a>
      <a href="/ui/events.html">Events</a>
      <a href="/ui/stats.html" class="active">Stats</a>
      <a href="/ui/about.html">About</a>
    </nav>
    <div class="controls">
      <select id="period">
        <option value="7">Last 7 days</option>
        <option value="30" selected>Last 30 days</option>
        <option value="90">Last 90 days</option>
        <option value="365">Last year</option>
      </select>
      <select id="camera">
        <option value="">All Cameras</option>
      </select>
      <button id="refresh" class="primary">Refresh</button>
    </div>
    <button class="mobile-menu-toggle" id="mobileMenuToggle">
      <div class="hamburger">
        <span></span>
        <span></span>
        <span></span>
      </div>
    </button>
    <div id="status" class="status" style="display:none"></div>
    
    <!-- Mobile Navigation -->
    <div class="mobile-nav" id="mobileNav">
      <nav class="nav">
        <a href="/ui/detections.html">AI Detections</a>
        <a href="/ui/events.html">Events</a>
        <a href="/ui/stats.html" class="active">Stats</a>
        <a href="/ui/about.html">About</a>
      </nav>
      <div class="mobile-controls">
        <div class="controls">
          <select id="mobilePeriod">
            <option value="7">Last 7 days</option>
            <option value="30" selected>Last 30 days</option>
            <option value="90">Last 90 days</option>
            <option value="365">Last year</option>
          </select>
          <select id="mobileCamera">
            <option value="">All Cameras</option>
          </select>
          <button id="mobileRefresh" class="primary">Refresh</button>
        </div>
      </div>
    </div>
  </header>
  <main>
    <!-- Motion Detection Summary -->
    <div id="summary" class="summary-stats" style="display:none"></div>
    
    <!-- Detection Analytics -->
    <div id="detection-stats" class="detection-stats" style="display:none">
      <div class="detection-card">
        <div class="detection-value" id="totalDetections">-</div>
        <div class="detection-label">Total Detections</div>
      </div>
      <div class="detection-card">
        <div class="detection-value" id="detectionTypes">-</div>
        <div class="detection-label">Detection Types</div>
      </div>
      <div class="detection-card">
        <div class="detection-value" id="avgConfidence">-</div>
        <div class="detection-label">Avg Confidence</div>
      </div>
      <div class="detection-card">
        <div class="detection-value" id="highConfidence">-</div>
        <div class="detection-label">High Confidence</div>
      </div>
    </div>

    <!-- Detection Charts -->
    <div id="detection-charts" class="stats-grid" style="display:none">
      <div class="stat-card">
        <h3>Detections by Type</h3>
        <div class="chart-container">
          <canvas id="detectionTypeChart"></canvas>
        </div>
      </div>
      <div class="stat-card">
        <h3>Daily Detection Trends</h3>
        <div class="chart-container">
          <canvas id="detectionDailyChart"></canvas>
        </div>
      </div>
    </div>

    <!-- Motion Detection Charts -->
    <div id="charts" class="stats-grid" style="display:none"></div>

    <!-- Detection Filters -->
    <div id="detection-filters" class="filter-section" style="display:none">
      <div class="filter-row">
        <label>Detection Type:</label>
        <select id="detectionTypeFilter">
          <option value="">All Types</option>
          <option value="person">Person</option>
          <option value="car">Car</option>
          <option value="truck">Truck</option>
          <option value="bicycle">Bicycle</option>
          <option value="motorcycle">Motorcycle</option>
        </select>
        <label>Min Confidence:</label>
        <input type="range" id="confidenceFilter" min="0" max="1" step="0.1" value="0">
        <span id="confidenceValue">0.0</span>
        <button id="applyDetectionFilters" class="primary">Apply Filters</button>
        <button id="clearDetectionFilters">Clear</button>
      </div>
    </div>

    <!-- Recent Detections List -->
    <div id="detection-list" class="detection-list" style="display:none">
      <div style="padding:16px;border-bottom:1px solid #2a2f3a;font-weight:600">Recent Detections</div>
      <div id="detectionListContent">
        <div class="loading">Loading detections...</div>
      </div>
    </div>
    <div id="loading" class="loading">Loading stats...</div>
    <div id="error" class="error" style="display:none"></div>
  </main>

<script>
// Motion Detection Elements
const summary = document.getElementById('summary');
const charts = document.getElementById('charts');
const loading = document.getElementById('loading');
const error = document.getElementById('error');
const status = document.getElementById('status');
const periodSelect = document.getElementById('period');
const cameraSelect = document.getElementById('camera');
const refreshBtn = document.getElementById('refresh');

// Detection Elements
const detectionStats = document.getElementById('detection-stats');
const detectionCharts = document.getElementById('detection-charts');
const detectionFilters = document.getElementById('detection-filters');
const detectionList = document.getElementById('detection-list');
const detectionListContent = document.getElementById('detectionListContent');

let currentData = null;
let currentDetectionData = null;
let currentDetections = [];
let chartInstances = [];
let detectionTypeChart, detectionDailyChart;

function showStatus(message, type = 'loading') {
  status.textContent = message;
  status.className = `status ${type}`;
  status.style.display = 'block';
}

function hideStatus() {
  status.style.display = 'none';
}

function showError(message) {
  error.textContent = message;
  error.style.display = 'block';
  loading.style.display = 'none';
  charts.style.display = 'none';
  summary.style.display = 'none';
  detectionStats.style.display = 'none';
  detectionCharts.style.display = 'none';
  detectionFilters.style.display = 'none';
  detectionList.style.display = 'none';
}

function hideError() {
  error.style.display = 'none';
}

// Initialize detection charts
function initDetectionCharts() {
  // Type chart
  const typeCtx = document.getElementById('detectionTypeChart').getContext('2d');
  detectionTypeChart = new Chart(typeCtx, {
    type: 'doughnut',
    data: {
      labels: [],
      datasets: [{
        data: [],
        backgroundColor: [
          '#375dfb', '#44ff44', '#ffaa44', '#ff44ff', '#666666'
        ],
        borderWidth: 0
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: {
          labels: {
            color: '#e8e8e8'
          }
        }
      }
    }
  });

  // Daily chart
  const dailyCtx = document.getElementById('detectionDailyChart').getContext('2d');
  detectionDailyChart = new Chart(dailyCtx, {
    type: 'line',
    data: {
      labels: [],
      datasets: [{
        label: 'Detections',
        data: [],
        borderColor: '#375dfb',
        backgroundColor: '#375dfb20',
        fill: true,
        tension: 0.4
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      scales: {
        x: {
          ticks: {
            color: '#e8e8e8'
          },
          grid: {
            color: '#2a2f3a'
          }
        },
        y: {
          ticks: {
            color: '#e8e8e8'
          },
          grid: {
            color: '#2a2f3a'
          }
        }
      },
      plugins: {
        legend: {
          labels: {
            color: '#e8e8e8'
          }
        }
      }
    }
  });
}

// Load detection statistics
async function loadDetectionStats() {
  try {
    const timeRange = periodSelect.value;
    const response = await fetch(`/detections/stats?days=${timeRange}`);
    if (!response.ok) throw new Error('HTTP ' + response.status);
    
    currentDetectionData = await response.json();
    updateDetectionStatsDisplay();
    updateDetectionCharts();
  } catch (error) {
    console.error('Failed to load detection stats:', error);
    document.getElementById('totalDetections').textContent = 'Error';
  }
}

// Update detection statistics display
function updateDetectionStatsDisplay() {
  if (!currentDetectionData) return;
  
  document.getElementById('totalDetections').textContent = currentDetectionData.totalDetections.toLocaleString();
  document.getElementById('detectionTypes').textContent = Object.keys(currentDetectionData.byType).length;
  
  // Calculate average confidence
  const totalDetections = currentDetectionData.totalDetections;
  if (totalDetections > 0) {
    const confidenceRanges = currentDetectionData.byConfidence;
    let weightedSum = 0;
    let totalWeight = 0;
    
    Object.entries(confidenceRanges).forEach(([range, count]) => {
      let avgConf = 0.2; // Default for low
      if (range.includes('Very High')) avgConf = 0.95;
      else if (range.includes('High')) avgConf = 0.8;
      else if (range.includes('Medium')) avgConf = 0.6;
      
      weightedSum += avgConf * count;
      totalWeight += count;
    });
    
    const avgConfidence = totalWeight > 0 ? (weightedSum / totalWeight) : 0;
    document.getElementById('avgConfidence').textContent = (avgConfidence * 100).toFixed(1) + '%';
  } else {
    document.getElementById('avgConfidence').textContent = '0%';
  }
  
  // High confidence count
  const highConf = (currentDetectionData.byConfidence['Very High (0.9+)'] || 0) + 
                   (currentDetectionData.byConfidence['High (0.7-0.9)'] || 0);
  document.getElementById('highConfidence').textContent = highConf.toLocaleString();
}

// Update detection charts
function updateDetectionCharts() {
  if (!currentDetectionData) return;
  
  // Update type chart
  const typeData = Object.entries(currentDetectionData.byType)
    .sort((a, b) => b[1] - a[1])
    .slice(0, 5); // Top 5 types
  
  detectionTypeChart.data.labels = typeData.map(([type, _]) => type);
  detectionTypeChart.data.datasets[0].data = typeData.map(([_, count]) => count);
  detectionTypeChart.update();
  
  // Update daily chart
  const dailyData = currentDetectionData.dailyStats
    .sort((a, b) => new Date(a.date) - new Date(b.date))
    .slice(-90); // Last 90 days
  
  detectionDailyChart.data.labels = dailyData.map(d => d.date);
  detectionDailyChart.data.datasets[0].data = dailyData.map(d => d.count);
  detectionDailyChart.update();
}

// Load recent detections
async function loadDetections() {
  try {
    const response = await fetch('/detections/recent?limit=50');
    if (!response.ok) throw new Error('HTTP ' + response.status);
    
    const data = await response.json();
    currentDetections = data.detections || [];
    updateDetectionList();
  } catch (error) {
    console.error('Failed to load detections:', error);
    detectionListContent.innerHTML = '<div class="empty">Failed to load detections</div>';
  }
}

// Update detection list
function updateDetectionList() {
  if (currentDetections.length === 0) {
    detectionListContent.innerHTML = '<div class="empty">No detections found</div>';
    return;
  }
  
  const html = currentDetections.map(detection => {
    const confidencePercent = (detection.confidence * 100).toFixed(1);
    const timeStr = new Date(detection.createdAt * 1000).toLocaleString('en-US', {
      timeZone: 'America/Chicago',
      year: 'numeric',
      month: '2-digit', 
      day: '2-digit',
      hour: '2-digit',
      minute: '2-digit',
      second: '2-digit',
      hour12: true
    }) + ' CT';
    
    return `
      <div class="detection-item">
        <div class="detection-type">${detection.type}</div>
        <div class="confidence-bar">
          <div class="confidence-fill" style="width: ${detection.confidence * 100}%"></div>
        </div>
        <div class="detection-confidence">${confidencePercent}%</div>
        <div class="detection-time">${timeStr}</div>
        <div class="detection-bbox">[${detection.bboxX},${detection.bboxY},${detection.bboxWidth}x${detection.bboxHeight}]</div>
      </div>
    `;
  }).join('');
  
  detectionListContent.innerHTML = html;
}

// Apply detection filters
function applyDetectionFilters() {
  const detectionType = document.getElementById('detectionTypeFilter').value;
  const minConfidence = parseFloat(document.getElementById('confidenceFilter').value);
  
  let filtered = currentDetections;
  
  if (detectionType) {
    filtered = filtered.filter(d => d.type === detectionType);
  }
  
  if (minConfidence > 0) {
    filtered = filtered.filter(d => d.confidence >= minConfidence);
  }
  
  // Update list with filtered results
  if (filtered.length === 0) {
    detectionListContent.innerHTML = '<div class="empty">No detections match the filters</div>';
    return;
  }
  
  const html = filtered.map(detection => {
    const confidencePercent = (detection.confidence * 100).toFixed(1);
    const timeStr = new Date(detection.createdAt * 1000).toLocaleString('en-US', {
      timeZone: 'America/Chicago',
      year: 'numeric',
      month: '2-digit', 
      day: '2-digit',
      hour: '2-digit',
      minute: '2-digit',
      second: '2-digit',
      hour12: true
    }) + ' CT';
    
    return `
      <div class="detection-item">
        <div class="detection-type">${detection.type}</div>
        <div class="confidence-bar">
          <div class="confidence-fill" style="width: ${detection.confidence * 100}%"></div>
        </div>
        <div class="detection-confidence">${confidencePercent}%</div>
        <div class="detection-time">${timeStr}</div>
        <div class="detection-bbox">[${detection.bboxX},${detection.bboxY},${detection.bboxWidth}x${detection.bboxHeight}]</div>
      </div>
    `;
  }).join('');
  
  detectionListContent.innerHTML = html;
}

// Clear detection filters
function clearDetectionFilters() {
  document.getElementById('detectionTypeFilter').value = '';
  document.getElementById('confidenceFilter').value = '0';
  document.getElementById('confidenceValue').textContent = '0.0';
  updateDetectionList();
}

// Update confidence value display
function updateConfidenceValue() {
  const value = document.getElementById('confidenceFilter').value;
  document.getElementById('confidenceValue').textContent = parseFloat(value).toFixed(1);
}

async function fetchStats() {
  const period = periodSelect.value;
  const camera = cameraSelect.value;
  
  showStatus('Loading stats...', 'loading');
  hideError();
  
  try {
    const params = new URLSearchParams({ days: period });
    if (camera) params.append('camera', camera);
    
    const response = await fetch(`/stats/motion?${params}`);
    if (!response.ok) {
      const errorText = await response.text();
      throw new Error(`HTTP ${response.status}: ${errorText}`);
    }
    
    const data = await response.json();
    console.log('Stats data received:', data);
    currentData = data;
    
    // Validate data structure
    if (!data.dailyStats) data.dailyStats = [];
    if (!data.cameraStats) data.cameraStats = [];
    if (!data.hourlyStats) data.hourlyStats = [];
    
    // Populate camera dropdown
    populateCameraDropdown(data.cameraStats);
    
    // Update UI
    updateSummary(data);
    updateCharts(data);
    
    // Load detection data
    await loadDetectionStats();
    await loadDetections();
    
    hideStatus();
    loading.style.display = 'none';
    summary.style.display = 'grid';
    charts.style.display = 'grid';
    detectionStats.style.display = 'grid';
    detectionCharts.style.display = 'grid';
    detectionFilters.style.display = 'block';
    detectionList.style.display = 'block';
    
  } catch (e) {
    console.error('Failed to fetch stats:', e);
    showError('Failed to load stats: ' + e.message);
    hideStatus();
  }
}

function populateCameraDropdown(cameraStats) {
  // Clear existing options except "All Cameras"
  cameraSelect.innerHTML = '<option value="">All Cameras</option>';
  
  if (cameraStats && Array.isArray(cameraStats)) {
    cameraStats.forEach(stat => {
      const option = document.createElement('option');
      option.value = stat.camera;
      option.textContent = `${stat.camera} (${stat.count})`;
      cameraSelect.appendChild(option);
    });
  }
  
  // Sync mobile camera dropdown
  syncMobileControls();
}

function updateSummary(data) {
  const dailyStats = data.dailyStats || [];
  const totalEvents = dailyStats.reduce((sum, day) => sum + (day.total || 0), 0);
  const totalVideos = dailyStats.reduce((sum, day) => sum + (day.videos || 0), 0);
  const totalImages = dailyStats.reduce((sum, day) => sum + (day.images || 0), 0);
  const avgPerDay = dailyStats.length > 0 ? Math.round(totalEvents / dailyStats.length) : 0;
  
  summary.innerHTML = `
    <div class="summary-item">
      <div class="value">${totalEvents.toLocaleString()}</div>
      <div class="label">Total Events</div>
    </div>
    <div class="summary-item">
      <div class="value">${totalVideos.toLocaleString()}</div>
      <div class="label">Videos</div>
    </div>
    <div class="summary-item">
      <div class="value">${totalImages.toLocaleString()}</div>
      <div class="label">Images</div>
    </div>
    <div class="summary-item">
      <div class="value">${avgPerDay}</div>
      <div class="label">Avg/Day</div>
    </div>
  `;
}

function updateCharts(data) {
  // Clear existing charts
  chartInstances.forEach(chart => chart.destroy());
  chartInstances = [];
  charts.innerHTML = '';
  
  // Daily timeline chart
  createDailyChart(data.dailyStats || []);
  
  // Camera breakdown chart
  createCameraChart(data.cameraStats || []);
  
  // Hourly distribution chart
  createHourlyChart(data.hourlyStats || []);
}

function createDailyChart(dailyStats) {
  const card = document.createElement('div');
  card.className = 'stat-card';
  card.innerHTML = '<h3>Daily Motion Detections</h3><div class="chart-container"><canvas id="dailyChart"></canvas></div>';
  charts.appendChild(card);
  
  if (!dailyStats || dailyStats.length === 0) {
    card.innerHTML = '<h3>Daily Motion Detections</h3><div class="chart-container"><p style="text-align:center;opacity:0.6;padding:40px">No data available</p></div>';
    return;
  }
  
  const ctx = document.getElementById('dailyChart').getContext('2d');
  const chart = new Chart(ctx, {
    type: 'line',
    data: {
      labels: dailyStats.map(d => d.date).reverse(),
      datasets: [
        {
          label: 'Total',
          data: dailyStats.map(d => d.total).reverse(),
          borderColor: '#375dfb',
          backgroundColor: 'rgba(55, 93, 251, 0.1)',
          tension: 0.4
        },
        {
          label: 'Videos',
          data: dailyStats.map(d => d.videos).reverse(),
          borderColor: '#44ff44',
          backgroundColor: 'rgba(68, 255, 68, 0.1)',
          tension: 0.4
        },
        {
          label: 'Images',
          data: dailyStats.map(d => d.images).reverse(),
          borderColor: '#ff6666',
          backgroundColor: 'rgba(255, 102, 102, 0.1)',
          tension: 0.4
        }
      ]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: {
          labels: { color: '#e8e8e8' }
        }
      },
      scales: {
        x: {
          ticks: { color: '#e8e8e8' },
          grid: { color: '#2a2f3a' }
        },
        y: {
          ticks: { color: '#e8e8e8' },
          grid: { color: '#2a2f3a' },
          beginAtZero: true
        }
      }
    }
  });
  
  chartInstances.push(chart);
}

function createCameraChart(cameraStats) {
  const card = document.createElement('div');
  card.className = 'stat-card';
  card.innerHTML = '<h3>Events by Camera</h3><div class="chart-container"><canvas id="cameraChart"></canvas></div>';
  charts.appendChild(card);
  
  if (!cameraStats || cameraStats.length === 0) {
    card.innerHTML = '<h3>Events by Camera</h3><div class="chart-container"><p style="text-align:center;opacity:0.6;padding:40px">No data available</p></div>';
    return;
  }
  
  const ctx = document.getElementById('cameraChart').getContext('2d');
  const chart = new Chart(ctx, {
    type: 'doughnut',
    data: {
      labels: cameraStats.map(c => c.camera),
      datasets: [{
        data: cameraStats.map(c => c.count),
        backgroundColor: [
          '#375dfb',
          '#44ff44',
          '#ff6666',
          '#ffaa44',
          '#aa44ff',
          '#44aaff'
        ]
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: {
          labels: { color: '#e8e8e8' }
        }
      }
    }
  });
  
  chartInstances.push(chart);
}

function createHourlyChart(hourlyStats) {
  const card = document.createElement('div');
  card.className = 'stat-card';
  card.innerHTML = '<h3>Hourly Distribution (Last 7 Days)</h3><div class="chart-container"><canvas id="hourlyChart"></canvas></div>';
  charts.appendChild(card);
  
  if (!hourlyStats || hourlyStats.length === 0) {
    card.innerHTML = '<h3>Hourly Distribution (Last 7 Days)</h3><div class="chart-container"><p style="text-align:center;opacity:0.6;padding:40px">No data available</p></div>';
    return;
  }
  
  // Create 24-hour array with zeros
  const hourlyData = new Array(24).fill(0);
  hourlyStats.forEach(stat => {
    const hour = parseInt(stat.hour);
    hourlyData[hour] = stat.count;
  });
  
  const ctx = document.getElementById('hourlyChart').getContext('2d');
  const chart = new Chart(ctx, {
    type: 'bar',
    data: {
      labels: Array.from({length: 24}, (_, i) => `${i.toString().padStart(2, '0')}:00`),
      datasets: [{
        label: 'Events',
        data: hourlyData,
        backgroundColor: 'rgba(55, 93, 251, 0.6)',
        borderColor: '#375dfb',
        borderWidth: 1
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: {
          labels: { color: '#e8e8e8' }
        }
      },
      scales: {
        x: {
          ticks: { color: '#e8e8e8' },
          grid: { color: '#2a2f3a' }
        },
        y: {
          ticks: { color: '#e8e8e8' },
          grid: { color: '#2a2f3a' },
          beginAtZero: true
        }
      }
    }
  });
  
  chartInstances.push(chart);
}

// Mobile menu functionality
const mobileMenuToggle = document.getElementById('mobileMenuToggle');
const mobileNav = document.getElementById('mobileNav');
const mobilePeriod = document.getElementById('mobilePeriod');
const mobileCamera = document.getElementById('mobileCamera');
const mobileRefresh = document.getElementById('mobileRefresh');

// Toggle mobile menu
mobileMenuToggle.addEventListener('click', function() {
  mobileMenuToggle.classList.toggle('active');
  mobileNav.classList.toggle('show');
});

// Close mobile menu when clicking outside
document.addEventListener('click', function(event) {
  if (!mobileMenuToggle.contains(event.target) && !mobileNav.contains(event.target)) {
    mobileMenuToggle.classList.remove('active');
    mobileNav.classList.remove('show');
  }
});

// Sync mobile controls with desktop controls
function syncMobileControls() {
  mobilePeriod.value = periodSelect.value;
  mobileCamera.innerHTML = cameraSelect.innerHTML;
  mobileCamera.value = cameraSelect.value;
}

// Mobile control event listeners
mobilePeriod.addEventListener('change', function() {
  periodSelect.value = mobilePeriod.value;
  fetchStats();
});

mobileCamera.addEventListener('change', function() {
  cameraSelect.value = mobileCamera.value;
  fetchStats();
});

mobileRefresh.addEventListener('click', function() {
  fetchStats();
});

// Event listeners
periodSelect.addEventListener('change', fetchStats);
cameraSelect.addEventListener('change', fetchStats);
refreshBtn.addEventListener('click', fetchStats);

// Detection event listeners
document.getElementById('applyDetectionFilters').onclick = applyDetectionFilters;
document.getElementById('clearDetectionFilters').onclick = clearDetectionFilters;
document.getElementById('confidenceFilter').oninput = updateConfidenceValue;

// Initialize
initDetectionCharts();
fetchStats();

// Auto-refresh every 30 seconds
setInterval(() => {
  fetchStats();
}, 30000);
</script>
</body>
</html>
